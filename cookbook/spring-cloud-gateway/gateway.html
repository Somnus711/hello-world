<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.3">
<title>如何包括Spring Cloud Gateway</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
body{margin:0}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
body{-webkit-font-smoothing:antialiased}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
body{tab-size:4}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css">
<style>
.hidden {
	display: none;
}

.switch {
	border-width: 1px 1px 0 1px;
	border-style: solid;
	border-color: #7a2518;
	display: inline-block;
}

.switch--item {
	padding: 10px;
	background-color: #ffffff;
	color: #7a2518;
	display: inline-block;
	cursor: pointer;
}

.switch--item:not(:first-child) {
	border-width: 0 0 0 1px;
	border-style: solid;
	border-color: #7a2518;
}

.switch--item.selected {
	background-color: #7a2519;
	color: #ffffff;
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js"></script>
<script type="text/javascript">
function addBlockSwitches() {
	$('.primary').each(function() {
		primary = $(this);
		createSwitchItem(primary, createBlockSwitch(primary)).item.addClass("selected");
		primary.children('.title').remove();
	});
	$('.secondary').each(function(idx, node) {
		secondary = $(node);
		primary = findPrimary(secondary);
		switchItem = createSwitchItem(secondary, primary.children('.switch'));
		switchItem.content.addClass('hidden');
		findPrimary(secondary).append(switchItem.content);
		secondary.remove();
	});
}

function createBlockSwitch(primary) {
	blockSwitch = $('<div class="switch"></div>');
	primary.prepend(blockSwitch);
	return blockSwitch;
}

function findPrimary(secondary) {
	candidate = secondary.prev();
	while (!candidate.is('.primary')) {
		candidate = candidate.prev();
	}
	return candidate;
}

function createSwitchItem(block, blockSwitch) {
	blockName = block.children('.title').text();
	content = block.children('.content').first().append(block.next('.colist'));
	item = $('<div class="switch--item">' + blockName + '</div>');
	item.on('click', '', content, function(e) {
		$(this).addClass('selected');
		$(this).siblings().removeClass('selected');
		e.data.siblings('.content').addClass('hidden');
		e.data.removeClass('hidden');
	});
	blockSwitch.append(item);
	return {'item': item, 'content': content};
}

$(addBlockSwitches);
</script>

</head>
<body class="book toc2 toc-left">
<div id="header">
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#gateway-starter">1. 如何包括Spring Cloud Gateway</a></li>
<li><a href="#_术语">2. 术语</a></li>
<li><a href="#gateway-how-it-works">3. 如何运行的</a></li>
<li><a href="#gateway-request-predicates-factories">4. Route Predicate工厂</a>
<ul class="sectlevel2">
<li><a href="#_after路由谓词工厂">4.1. After路由谓词工厂</a></li>
<li><a href="#_before路由谓词工厂">4.2. Before路由谓词工厂</a></li>
<li><a href="#_between路由谓词工厂">4.3. Between路由谓词工厂</a></li>
<li><a href="#_cookie路由谓词工厂">4.4. Cookie路由谓词工厂</a></li>
<li><a href="#_header路由谓词工厂">4.5. Header路由谓词工厂</a></li>
<li><a href="#_host路由谓词工厂">4.6. Host路由谓词工厂</a></li>
<li><a href="#_method路由谓词工厂">4.7. Method路由谓词工厂</a></li>
<li><a href="#_path路由谓词工厂">4.8. Path路由谓词工厂</a></li>
<li><a href="#_query路由谓词工厂">4.9. Query路由谓词工厂</a></li>
<li><a href="#_remoteaddr路由谓词工厂">4.10. RemoteAddr路由谓词工厂</a></li>
<li><a href="#_weight路由谓词工厂">4.11. Weight路由谓词工厂</a></li>
</ul>
</li>
<li><a href="#gateway-route-filters">5. <code>GatewayFilter</code> 工厂</a>
<ul class="sectlevel2">
<li><a href="#__code_addrequestheader_code_code_gatewayfilter_code_工厂">5.1. <code>AddRequestHeader</code> <code>GatewayFilter</code> 工厂</a></li>
<li><a href="#__code_addrequestparameter_code_code_gatewayfilter_code_工厂">5.2. <code>AddRequestParameter</code> <code>GatewayFilter</code> 工厂</a></li>
<li><a href="#__code_addresponseheader_code_code_gatewayfilter_code_工厂">5.3. <code>AddResponseHeader</code> <code>GatewayFilter</code> 工厂</a></li>
<li><a href="#__code_deduperesponseheader_code_code_gatewayfilter_code_工厂">5.4. <code>DedupeResponseHeader</code> <code>GatewayFilter</code> 工厂</a></li>
<li><a href="#hystrix">5.5. Hystrix <code>GatewayFilter</code> 工厂</a></li>
<li><a href="#spring-cloud-circuitbreaker-filter-factory">5.6. Spring Cloud CircuitBreaker <code>GatewayFilter</code> 工厂</a></li>
<li><a href="#fallback-headers">5.7. <code>FallbackHeaders</code> <code>GatewayFilter</code> 工厂</a></li>
<li><a href="#__code_maprequestheader_code_code_gatewayfilter_code_工厂">5.8. <code>MapRequestHeader</code> <code>GatewayFilter</code> 工厂</a></li>
<li><a href="#__code_prefixpath_code_code_gatewayfilter_code_工厂">5.9. <code>PrefixPath</code> <code>GatewayFilter</code> 工厂</a></li>
<li><a href="#__code_preservehostheader_code_code_gatewayfilter_code_工厂">5.10. <code>PreserveHostHeader</code> <code>GatewayFilter</code> 工厂</a></li>
<li><a href="#__code_requestratelimiter_code_code_gatewayfilter_code_工厂">5.11. <code>RequestRateLimiter</code> <code>GatewayFilter</code> 工厂</a></li>
<li><a href="#__code_redirectto_code_code_gatewayfilter_code_工厂">5.12. <code>RedirectTo</code> <code>GatewayFilter</code> 工厂</a></li>
<li><a href="#__code_removehopbyhopheadersfilter_code_code_gatewayfilter_code_工厂">5.13. <code>RemoveHopByHopHeadersFilter</code> <code>GatewayFilter</code> 工厂</a></li>
<li><a href="#__code_removerequestheader_code_code_gatewayfilter_code_工厂">5.14. <code>RemoveRequestHeader</code> <code>GatewayFilter</code> 工厂</a></li>
<li><a href="#__code_removeresponseheader_code_code_gatewayfilter_code_工厂">5.15. <code>RemoveResponseHeader</code> <code>GatewayFilter</code> 工厂</a></li>
<li><a href="#__code_removerequestparameter_code_code_gatewayfilter_code_工厂">5.16. <code>RemoveRequestParameter</code> <code>GatewayFilter</code> 工厂</a></li>
<li><a href="#__code_rewritepath_code_code_gatewayfilter_code_工厂">5.17. <code>RewritePath</code> <code>GatewayFilter</code> 工厂</a></li>
<li><a href="#__code_rewritelocationresponseheader_code_code_gatewayfilter_code_工厂">5.18. <code>RewriteLocationResponseHeader</code> <code>GatewayFilter</code> 工厂</a></li>
<li><a href="#__code_rewriteresponseheader_code_code_gatewayfilter_code_工厂">5.19. <code>RewriteResponseHeader</code> <code>GatewayFilter</code> 工厂</a></li>
<li><a href="#__code_savesession_code_code_gatewayfilter_code_工厂">5.20. <code>SaveSession</code> <code>GatewayFilter</code> 工厂</a></li>
<li><a href="#__code_secureheaders_code_code_gatewayfilter_code_工厂">5.21. <code>SecureHeaders</code> <code>GatewayFilter</code> 工厂</a></li>
<li><a href="#__code_setpath_code_code_gatewayfilter_code_工厂">5.22. <code>SetPath</code> <code>GatewayFilter</code> 工厂</a></li>
<li><a href="#__code_setrequestheader_code_code_gatewayfilter_code_工厂">5.23. <code>SetRequestHeader</code> <code>GatewayFilter</code> 工厂</a></li>
<li><a href="#__code_setresponseheader_code_code_gatewayfilter_code_工厂">5.24. <code>SetResponseHeader</code> <code>GatewayFilter</code> 工厂</a></li>
<li><a href="#__code_setstatus_code_code_gatewayfilter_code_工厂">5.25. <code>SetStatus</code> <code>GatewayFilter</code> 工厂</a></li>
<li><a href="#__code_stripprefix_code_code_gatewayfilter_code_工厂">5.26. <code>StripPrefix</code> <code>GatewayFilter</code> 工厂</a></li>
<li><a href="#_retry_code_gatewayfilter_code_工厂">5.27. Retry <code>GatewayFilter</code> 工厂</a></li>
<li><a href="#__code_requestsize_code_code_gatewayfilter_code_工厂">5.28. <code>RequestSize</code> <code>GatewayFilter</code> 工厂</a></li>
<li><a href="#_修改请求体_code_gatewayfilter_code_工厂">5.29. 修改请求体 <code>GatewayFilter</code> 工厂</a></li>
<li><a href="#_修改响应体_code_gatewayfilter_code_工厂">5.30. 修改响应体 <code>GatewayFilter</code> 工厂</a></li>
<li><a href="#_默认过滤器">5.31. 默认过滤器</a></li>
</ul>
</li>
<li><a href="#_全局过滤器">6. 全局过滤器</a>
<ul class="sectlevel2">
<li><a href="#gateway-combined-global-filter-and-gatewayfilter-ordering">6.1. 全局过滤器和 <code>GatewayFilter</code> 组合的顺序</a></li>
<li><a href="#_forward路由过滤器">6.2. Forward路由过滤器</a></li>
<li><a href="#__code_loadbalancerclient_code_过滤器">6.3. <code>LoadBalancerClient</code> 过滤器</a></li>
<li><a href="#reactive-loadbalancer-client-filter">6.4. The <code>ReactiveLoadBalancerClientFilter</code></a></li>
<li><a href="#_netty路由过滤器">6.5. Netty路由过滤器</a></li>
<li><a href="#_netty写响应过滤器">6.6. Netty写响应过滤器</a></li>
<li><a href="#__code_routetorequesturl_code_过滤器">6.7. <code>RouteToRequestUrl</code> 过滤器</a></li>
<li><a href="#_websocket路由过滤器">6.8. Websocket路由过滤器</a></li>
<li><a href="#_网关指标过滤器">6.9. 网关指标过滤器</a></li>
<li><a href="#_将交换标记为已路由">6.10. 将交换标记为已路由</a></li>
</ul>
</li>
<li><a href="#_tls和ssl">7. TLS和SSL</a>
<ul class="sectlevel2">
<li><a href="#_tls握手">7.1. TLS握手</a></li>
</ul>
</li>
<li><a href="#_配置">8. 配置</a></li>
<li><a href="#_路由元数据配置">9. 路由元数据配置</a></li>
<li><a href="#_http超时配置">10. Http超时配置</a>
<ul class="sectlevel2">
<li><a href="#_全局超时">10.1. 全局超时</a></li>
<li><a href="#_每个路由超时">10.2. 每个路由超时</a></li>
<li><a href="#_流式java路由api">10.3. 流式Java路由API</a></li>
<li><a href="#__code_discoveryclient_code_路由定义定位器">10.4. <code>DiscoveryClient</code> 路由定义定位器</a></li>
</ul>
</li>
<li><a href="#_reactor_netty访问日志">11. Reactor Netty访问日志</a></li>
<li><a href="#_cors配置">12. CORS配置</a></li>
<li><a href="#_actuator_api">13. Actuator API</a>
<ul class="sectlevel2">
<li><a href="#_详细actuator格式">13.1. 详细Actuator格式</a></li>
<li><a href="#_检索路由过滤器">13.2. 检索路由过滤器</a></li>
<li><a href="#_刷新路由缓存">13.3. 刷新路由缓存</a></li>
<li><a href="#_检索网关中定义的路由">13.4. 检索网关中定义的路由</a></li>
<li><a href="#gateway-retrieving-information-about-a-particular-route">13.5. 检索有关特定路由的信息</a></li>
<li><a href="#_创建和删除特定路由">13.6. 创建和删除特定路由</a></li>
<li><a href="#_回顾_所有端点的列表">13.7. 回顾：所有端点的列表</a></li>
</ul>
</li>
<li><a href="#troubleshooting">14. 故障排除</a>
<ul class="sectlevel2">
<li><a href="#_日志级别">14.1. 日志级别</a></li>
<li><a href="#_窃听">14.2. 窃听</a></li>
</ul>
</li>
<li><a href="#_开发人员指南">15. 开发人员指南</a>
<ul class="sectlevel2">
<li><a href="#_编写自定义路由谓词工厂">15.1. 编写自定义路由谓词工厂</a></li>
<li><a href="#_编写自定义gatewayfilter工厂">15.2. 编写自定义GatewayFilter工厂</a></li>
<li><a href="#_编写自定义全局过滤器">15.3. 编写自定义全局过滤器</a></li>
<li><a href="#_编写自定义路由locators和writers">15.4. 编写自定义路由Locators和Writers</a></li>
</ul>
</li>
<li><a href="#_使用spring_mvc或webflux构建一个简单的网关">16. 使用Spring MVC或Webflux构建一个简单的网关</a></li>
<li><a href="#_配置属性">17. 配置属性</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="gateway-starter">1. 如何包括Spring Cloud Gateway</h2>
<div class="sectionbody">
<div class="paragraph">
<p>要将Spring Cloud Gateway包含在你的项目中，请使用启动器，其组ID为 <code>org.springframework.cloud</code>，
工件ID为​<code>spring-cloud-starter-gateway</code>。有关使用当前Spring Cloud Release Train设置构建系统的详细信息，
请参见 <a href="https://projects.spring.io/spring-cloud/">Spring Cloud Project页面</a>。</p>
</div>
<div class="paragraph">
<p>如果包括启动器，但不希望启用网关，请设置 <code>spring.cloud.gateway.enabled=false</code>。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Spring Cloud Gateway基于 <a href="https://spring.io/projects/spring-boot#learn">Spring Boot 2.x</a>，
<a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html">Spring WebFlux</a>和
<a href="https://projectreactor.io/docs">Project Reactor</a>构建。结果，当你使用Spring Cloud Gateway时，
许多你熟悉的同步库（例如：Spring Data和Spring Security）和模式可能不适用。如果你对这些项目不熟悉，建议你在使用Spring Cloud
Gateway之前先阅读它们的文档以熟悉一些新概念。
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Spring Cloud Gateway需要Spring Boot和Spring Webflux提供的Netty运行时。它不能在传统的Servlet容器中或构建为WAR使用。
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_术语">2. 术语</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><strong>Route</strong>: 网关的基本构建块。它由ID，目标URI，谓词集合和过滤器集合定义。如果聚合谓词为true，则匹配路由。</p>
</li>
<li>
<p><strong>Predicate</strong>:  这是一个 {javadoc-se}/java/util/function/Predicate.html[Java 8 Function Predicate]。
输入类型是 {javadoc-spring}/web/server/ServerWebExchange.html[Spring Framework <code>ServerWebExchange</code>]。
这使你可以匹配HTTP请求中的所有内容，例如请求头或参数。</p>
</li>
<li>
<p><strong>Filter</strong>: 这些是使用特定工厂构造的 {javadoc-spring}/web/server/GatewayFilter.html[Spring Framework <code>GatewayFilter</code>]实例。
在这里，你可以在发送下游请求之前或之后修改请求和响应。</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="gateway-how-it-works">3. 如何运行的</h2>
<div class="sectionbody">
<div class="paragraph">
<p>下图从总体上概述了Spring Cloud Gateway的工作方式：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/spring-cloud-gateway/spring_cloud_gateway_diagram.png" alt="Spring Cloud Gateway Diagram">
</div>
</div>
<div class="paragraph">
<p>客户端向Spring Cloud Gateway发出请求。如果Gateway Handler Mapping确定请求与路由匹配，则将其发送到Gateway Web Handler。
该处理程序通过特定于请求的过滤器链来运行请求。过滤器由虚线分隔的原因是，过滤器可以在发送代理请求之前和之后运行逻辑。
先执行所有“<code>pre</code>”过滤器逻辑，然后发出代理请求。在请求代理执行完后，将运行“<code>post</code>”过滤器逻辑。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
在没有端口的路由中定义的URI，HTTP和HTTPS URI的默认端口值分别为80和443。
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="gateway-request-predicates-factories">4. Route Predicate工厂</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Cloud Gateway将路由匹配作为Spring WebFlux <code>HandlerMapping</code> 基础架构的一部分。
Spring Cloud Gateway包括许多内置的路由谓词工厂。所有这些谓词都与HTTP请求的不同属性匹配。
你可以将多个路由谓词工厂与逻辑 <code>and</code> 语句组合使用。</p>
</div>
<div class="sect2">
<h3 id="_after路由谓词工厂">4.1. After路由谓词工厂</h3>
<div class="paragraph">
<p>After路由谓词工厂有一个参数，即 <code>datetime</code>。该谓词匹配在指定 <code>datetime</code> 之后发生的请求。以下示例配置了after路由谓词：</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: after_route
        uri: https://example.org
        predicates:
        - After=2017-01-20T17:42:47.789-07:00[America/Denver]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>该路由匹配2017-01-20 17:42 Mountain Time (Denver)之后的任何请求。</p>
</div>
</div>
<div class="sect2">
<h3 id="_before路由谓词工厂">4.2. Before路由谓词工厂</h3>
<div class="paragraph">
<p>Before路由谓词工厂有一个参数，即 <code>datetime</code>。该谓词匹配在指定 <code>datetime</code> 之前发生的请求。以下示例配置了before路由谓词：</p>
</div>
<div class="exampleblock">
<div class="title">Example 2. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: before_route
        uri: https://example.org
        predicates:
        - Before=2017-01-20T17:42:47.789-07:00[America/Denver]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>该路由匹配2017-01-20 17:42 Mountain Time (Denver)之前的任何请求。</p>
</div>
</div>
<div class="sect2">
<h3 id="_between路由谓词工厂">4.3. Between路由谓词工厂</h3>
<div class="paragraph">
<p>Between路由谓词工厂之间有两个参数：<code>datetime1</code> 和 <code>datetime2</code>。该谓词匹配在 <code>datetime1</code> 之后和 <code>datetime2</code> 之前发生的请求。
<code>datetime2</code> 参数必须在 <code>datetime1</code> 之后。以下示例配置了between路由谓词：</p>
</div>
<div class="exampleblock">
<div class="title">Example 3. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: between_route
        uri: https://example.org
        predicates:
        - Between=2017-01-20T17:42:47.789-07:00[America/Denver], 2017-01-21T17:42:47.789-07:00[America/Denver]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>该路由与2017-01-20 17:42 Mountain Time (Denver)之后和2017-01-21 17:42 Mountain Time (Denver)
之前的任何请求相匹配。这对于维护窗口可能很有用。</p>
</div>
</div>
<div class="sect2">
<h3 id="_cookie路由谓词工厂">4.4. Cookie路由谓词工厂</h3>
<div class="paragraph">
<p>Cookie路由谓词工厂有两个参数，即cookie名称和正则表达式。该谓词匹配具有给定名称且其值与正则表达式匹配的cookie。
以下示例配置cookie路由谓词工厂：</p>
</div>
<div class="exampleblock">
<div class="title">Example 4. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: cookie_route
        uri: https://example.org
        predicates:
        - Cookie=chocolate, ch.p</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>此路由匹配具有名为 <code>chocolate</code> 的cookie的请求，该cookie的值与 <code>ch.p</code> 正则表达式匹配。</p>
</div>
</div>
<div class="sect2">
<h3 id="_header路由谓词工厂">4.5. Header路由谓词工厂</h3>
<div class="paragraph">
<p>Header路由谓词工厂有两个参数，请求头名称和正则表达式。该谓词匹配具有给定名称且其值与正则表达式匹配的请求头。
以下示例配置header路由谓词：</p>
</div>
<div class="exampleblock">
<div class="title">Example 5. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: header_route
        uri: https://example.org
        predicates:
        - Header=X-Request-Id, \d+</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>如果请求具有名为 <code>X-Request-Id</code> 的请求头，且该请求头的值与 <code>\d+</code> 正则表达式匹配（即其值为一个或多个数字），则此路由匹配。</p>
</div>
</div>
<div class="sect2">
<h3 id="_host路由谓词工厂">4.6. Host路由谓词工厂</h3>
<div class="paragraph">
<p>Host路由谓词工厂有一个参数：主机名模式列表。该模式是以 <code>.</code> 为分隔符，Ant样式的模式。该谓词与匹配模式的 <code>Host</code> 请求头匹配。
以下示例配置host路由谓词：</p>
</div>
<div class="exampleblock">
<div class="title">Example 6. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: host_route
        uri: https://example.org
        predicates:
        - Host=**.somehost.org,**.anotherhost.org</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>还支持URI模板变量（例如：<code>{sub}.myhost.org</code>）。</p>
</div>
<div class="paragraph">
<p>如果请求的 <code>Host 头的值为 `www.somehost.org</code> 或 <code>beta.somehost.org</code> 或 <code>www.anotherhost.org</code>，则此路由匹配。</p>
</div>
<div class="paragraph">
<p>该谓词提取URI模板变量（如上例中定义的 <code>sub</code>）作为名称和值的映射，并使用 <code>ServerWebExchangeUtils.URI_TEMPLATE_VARIABLES_ATTRIBUTE</code>
中定义的键将其放置在 <code>ServerWebExchange.getAttributes()</code> 中。
这些值可供<a href="#gateway-route-filters"><code>GatewayFilter</code> 工厂</a>使用。</p>
</div>
</div>
<div class="sect2">
<h3 id="_method路由谓词工厂">4.7. Method路由谓词工厂</h3>
<div class="paragraph">
<p>Method路由谓词工厂有一个或多个参数：要匹配的HTTP方法。以下示例配置method路由谓词：</p>
</div>
<div class="exampleblock">
<div class="title">Example 7. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: method_route
        uri: https://example.org
        predicates:
        - Method=GET,POST</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>如果请求方法是 <code>GET</code> 或 <code>POST</code>，则此路由匹配。</p>
</div>
</div>
<div class="sect2">
<h3 id="_path路由谓词工厂">4.8. Path路由谓词工厂</h3>
<div class="paragraph">
<p>Path路由谓词工厂有两个参数：Spring <code>PathMatcher</code> 模式列表和一个称为 <code>matchOptionalTrailingSeparator</code> 的可选标志。
以下示例配置path路由谓词：</p>
</div>
<div class="exampleblock">
<div class="title">Example 8. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: host_route
        uri: https://example.org
        predicates:
        - Path=/red/{segment},/blue/{segment}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>如果请求路径为 <code>/red/1</code> 或 <code>/red/blue</code> 或 <code>/blue/green</code>，则此路由匹配。</p>
</div>
<div class="paragraph">
<p>该谓词提取URI模板变量（如上例中定义的 <code>segment</code>）作为名称和值的映射，
并使用 <code>ServerWebExchangeUtils.URI_TEMPLATE_VARIABLES_ATTRIBUTE</code> 中定义的键将其放置在
<code>ServerWebExchange.getAttributes()</code> 中。这些值可供<a href="#gateway-route-filters"><code>GatewayFilter</code> 工厂</a>使用。</p>
</div>
<div class="paragraph">
<p>可以使用实用工具方法（即 <code>get</code>）来简化对这些变量的访问。下面的示例演示如何使用 <code>get</code> 方法：</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">Map&lt;String, String&gt; uriVariables = ServerWebExchangeUtils.getPathPredicateVariables(exchange);

String segment = uriVariables.get("segment");</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_query路由谓词工厂">4.9. Query路由谓词工厂</h3>
<div class="paragraph">
<p>Query路由谓词工厂有两个参数：一个必需的 <code>param</code> 和一个可选的 <code>regexp</code>。以下示例配置query路由谓词：</p>
</div>
<div class="exampleblock">
<div class="title">Example 9. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: query_route
        uri: https://example.org
        predicates:
        - Query=green</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>如果请求包含 <code>green</code> 查询参数，则上述路由匹配。</p>
</div>
<div class="listingblock">
<div class="title">application.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: query_route
        uri: https://example.org
        predicates:
        - Query=red, gree.</code></pre>
</div>
</div>
<div class="paragraph">
<p>如果请求包含一个值与 <code>gree</code> 匹配（因为是正则表达式，所以 <code>green</code> 和 <code>greet</code> 均匹配）的 <code>red</code> 查询参数，则上述路由匹配。</p>
</div>
</div>
<div class="sect2">
<h3 id="_remoteaddr路由谓词工厂">4.10. RemoteAddr路由谓词工厂</h3>
<div class="paragraph">
<p>RemoteAddr路由谓词工厂有一个参数：CIDR表示法（IPv4或IPv6）字符串的列表（最小大小为1），例如：<code>192.168.0.1/16</code>（其中
<code>192.168.0.1</code> 是IP地址，而 <code>16</code> 是子网掩码）。下面的示例配置RemoteAddr路由谓词：</p>
</div>
<div class="exampleblock">
<div class="title">Example 10. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: remoteaddr_route
        uri: https://example.org
        predicates:
        - RemoteAddr=192.168.1.1/24</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>如果请求的远程地址是 <code>192.168.1.10</code>，则此路由匹配。</p>
</div>
</div>
<div class="sect2">
<h3 id="_weight路由谓词工厂">4.11. Weight路由谓词工厂</h3>
<div class="paragraph">
<p>Weight路由谓词工厂有两个参数：<code>group</code> 和 <code>weight</code>。权重是按组计算的。以下示例配置weight路由谓词：</p>
</div>
<div class="exampleblock">
<div class="title">Example 11. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: weight_high
        uri: https://weighthigh.org
        predicates:
        - Weight=group1, 8
      - id: weight_low
        uri: https://weightlow.org
        predicates:
        - Weight=group1, 2</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>该路由会将约80%的流量转发至 <code><a href="https://weighthigh.org" class="bare">https://weighthigh.org</a></code>，并将约20%的流量转发至 <code><a href="https://weighlow.org" class="bare">https://weighlow.org</a></code>。</p>
</div>
<div class="sect3">
<h4 id="_修改远程地址的解析方式">4.11.1. 修改远程地址的解析方式</h4>
<div class="paragraph">
<p>默认情况下，RemoteAddr路由谓词工厂使用传入请求中的远程地址。如果Spring Cloud Gateway位于代理层后面，则此地址可能与实际的客户端IP地址不匹配。</p>
</div>
<div class="paragraph">
<p>你可以通过设置自定义的 <code>RemoteAddressResolver</code> 来自定义解析远程地址的方式。
Spring Cloud Gateway随附了一个基于 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Forwarded-For">X-Forwarded-For 请求头</a>
的非默认远程地址解析器 <code>XForwardedRemoteAddressResolver</code>。</p>
</div>
<div class="paragraph">
<p><code>XForwardedRemoteAddressResolver</code> 有两个静态构造函数方法，它们采用不同的安全性方法：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>XForwardedRemoteAddressResolver::trustAll</code> 返回一个 <code>RemoteAddressResolver</code>，
该地址始终采用 <code>X-Forwarded-For</code> 请求头中找到的第一个IP地址。这种方法容易受到欺骗，因为恶意客户端可能会为
<code>X-Forwarded-For</code> 设置初始值，该初始值将被解析程序接受。</p>
</li>
<li>
<p><code>XForwardedRemoteAddressResolver::maxTrustedIndex</code> 获取一个索引，该索引与在Spring Cloud Gateway前运行的受信任基础设施的数量相关。
例如：如果只能通过HAProxy访问Spring Cloud Gateway，则应使用值1。如果在访问Spring Cloud Gateway之前需要两跳可信基础设施，则应使用值2。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>考虑以下请求头值：</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>X-Forwarded-For: 0.0.0.1, 0.0.0.2, 0.0.0.3</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>以下 <code>maxTrustedIndex</code> 值产生以下远程地址：</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><code>maxTrustedIndex</code></th>
<th class="tableblock halign-left valign-top">结果</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">[<code>Integer.MIN_VALUE</code>,0]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(无效，初始化期间发生 <code>IllegalArgumentException</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0.0.3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0.0.2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0.0.1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">[4, <code>Integer.MAX_VALUE</code>]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0.0.1</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>以下示例显示了如何使用Java实现相同的配置：</p>
</div>
<div class="exampleblock">
<div class="title">Example 12. GatewayConfig.java</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">RemoteAddressResolver resolver = XForwardedRemoteAddressResolver
    .maxTrustedIndex(1);

...

.route("direct-route",
    r -&gt; r.remoteAddr("10.1.1.1", "10.10.1.1/24")
        .uri("https://downstream1")
.route("proxied-route",
    r -&gt; r.remoteAddr(resolver, "10.10.1.1", "10.10.1.1/24")
        .uri("https://downstream2")
)</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="gateway-route-filters">5. <code>GatewayFilter</code> 工厂</h2>
<div class="sectionbody">
<div class="paragraph">
<p>路由过滤器允许以某种方式修改传入的HTTP请求或传出的HTTP响应。路由过滤器适用于特定路由。
Spring Cloud Gateway包括许多内置的GatewayFilter工厂。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
有关如何使用下列任一过滤器的更详细的例子，请查看
{code-spring-cloud-gateway}/master/spring-cloud-gateway-core/src/test/java/org/springframework/cloud/gateway/filter/factory[单元测试]。
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="__code_addrequestheader_code_code_gatewayfilter_code_工厂">5.1. <code>AddRequestHeader</code> <code>GatewayFilter</code> 工厂</h3>
<div class="paragraph">
<p><code>AddRequestHeader</code> <code>GatewayFilter</code> 工厂采用名称和值参数。
下面的示例配置一个 <code>AddRequestHeader</code> <code>GatewayFilter</code>：</p>
</div>
<div class="exampleblock">
<div class="title">Example 13. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: add_request_header_route
        uri: https://example.org
        filters:
        - AddRequestHeader=X-Request-red, blue</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>此清单将 <code>X-Request-red:blue</code> 头部添加到所有匹配请求的下游请求头中。</p>
</div>
<div class="paragraph">
<p><code>AddRequestHeader</code> 知道用于匹配路径或主机的URI变量。URI变量可以在值中使用，并在运行时展开。
下面的示例配置使用变量的 <code>AddRequestHeader</code> <code>GatewayFilter</code>：</p>
</div>
<div class="exampleblock">
<div class="title">Example 14. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: add_request_header_route
        uri: https://example.org
        predicates:
        - Path=/red/{segment}
        filters:
        - AddRequestHeader=X-Request-Red, Blue-{segment}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="__code_addrequestparameter_code_code_gatewayfilter_code_工厂">5.2. <code>AddRequestParameter</code> <code>GatewayFilter</code> 工厂</h3>
<div class="paragraph">
<p><code>AddRequestParameter</code> <code>GatewayFilter</code> 工厂采用名称和值参数。
下面的示例配置一个 <code>AddRequestParameter</code> <code>GatewayFilter</code>：</p>
</div>
<div class="exampleblock">
<div class="title">Example 15. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: add_request_parameter_route
        uri: https://example.org
        filters:
        - AddRequestParameter=red, blue</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>这会将 <code>red=blue</code> 添加到所有匹配请求的下游请求的查询字符串中。</p>
</div>
<div class="paragraph">
<p><code>AddRequestParameter</code> 知道用于匹配路径或主机的URI变量。URI变量可以在值中使用，并在运行时展开。
下面的示例配置使用变量的 <code>AddRequestParameter</code> <code>GatewayFilter</code>：</p>
</div>
<div class="exampleblock">
<div class="title">Example 16. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: add_request_parameter_route
        uri: https://example.org
        predicates:
        - Host: {segment}.myhost.org
        filters:
        - AddRequestParameter=foo, bar-{segment}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="__code_addresponseheader_code_code_gatewayfilter_code_工厂">5.3. <code>AddResponseHeader</code> <code>GatewayFilter</code> 工厂</h3>
<div class="paragraph">
<p><code>AddResponseHeader</code> <code>GatewayFilter</code> 工厂采用名称和值参数。
以下示例配置一个 <code>AddResponseHeader</code> <code>GatewayFilter</code>：</p>
</div>
<div class="exampleblock">
<div class="title">Example 17. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: add_response_header_route
        uri: https://example.org
        filters:
        - AddResponseHeader=X-Response-Red, Blue</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>这会将 <code>X-Response-Foo:Bar</code> 头部添加到所有匹配请求的下游响应头中。</p>
</div>
<div class="paragraph">
<p><code>AddResponseHeader</code> 知道用于匹配路径或主机的URI变量。URI变量可以在值中使用，并在运行时展开。
以下示例配置使用变量的 <code>AddResponseHeader</code> <code>GatewayFilter</code>：</p>
</div>
<div class="exampleblock">
<div class="title">Example 18. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: add_response_header_route
        uri: https://example.org
        predicates:
        - Host: {segment}.myhost.org
        filters:
        - AddResponseHeader=foo, bar-{segment}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="__code_deduperesponseheader_code_code_gatewayfilter_code_工厂">5.4. <code>DedupeResponseHeader</code> <code>GatewayFilter</code> 工厂</h3>
<div class="paragraph">
<p><code>DedupeResponseHeader</code> <code>GatewayFilter</code> 工厂采用 <code>name</code> 参数和可选的 <code>strategy</code> 参数。
<code>name</code> 可以包含以空格分隔的响应头名称列表。以下示例配置了 <code>DedupeResponseHeader</code> <code>GatewayFilter</code>：</p>
</div>
<div class="exampleblock">
<div class="title">Example 19. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: dedupe_response_header_route
        uri: https://example.org
        filters:
        - DedupeResponseHeader=Access-Control-Allow-Credentials Access-Control-Allow-Origin</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>当网关CORS逻辑和下游逻辑都添加它们时，这将删除 <code>Access-Control-Allow-Credentials</code> 和
<code>Access-Control-Allow-Origin</code> 响应头的重复值。</p>
</div>
<div class="paragraph">
<p><code>DedupeResponseHeader</code> 过滤器还接受可选的 <code>strategy</code> 参数。
接受的值为 <code>RETAIN_FIRST</code>（默认值），<code>RETAIN_LAST</code> 和 <code>RETAIN_UNIQUE</code>。</p>
</div>
</div>
<div class="sect2">
<h3 id="hystrix">5.5. Hystrix <code>GatewayFilter</code> 工厂</h3>
<div class="paragraph">
<p><a href="https://cloud.spring.io/spring-cloud-netflix/multi/multi__modules_in_maintenance_mode.html">Netflix已将Hystrix置于维护模式</a>。
我们建议你将<a href="#spring-cloud-circuitbreaker-filter-factory">Spring Cloud CircuitBreaker 网关过滤器</a>
与Resilience4J一起使用，因为在将来的版本中将不再支持Hystrix。</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/Netflix/Hystrix">Hystrix</a>是Netflix的一个库，用于实现 <a href="https://martinfowler.com/bliki/CircuitBreaker.html">断路器模式</a>。
Hystrix <code>GatewayFilter</code> 可让你将断路器引入网关路由，保护你的服务免受级联故障的影响，并在下游故障的情况下提供降级响应。</p>
</div>
<div class="paragraph">
<p>要在项目中启用Hystrix <code>GatewayFilter</code> 实例，请添加来自 <a href="https://cloud.spring.io/spring-cloud-netflix/">Spring Cloud Netflix</a>
的 <code>spring-cloud-starter-netflix-hystrix</code> 的依赖。</p>
</div>
<div class="paragraph">
<p>Hystrix <code>GatewayFilter</code> 工厂需要一个 <code>name</code> 参数，即 <code>HystrixCommand</code> 的名称。以下示例配置了Hystrix <code>GatewayFilter</code>：</p>
</div>
<div class="exampleblock">
<div class="title">Example 20. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: hystrix_route
        uri: https://example.org
        filters:
        - Hystrix=myCommandName</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>这会将其余的过滤器包装在命令名称为 <code>myCommandName</code> 的 <code>HystrixCommand</code> 中。</p>
</div>
<div class="paragraph">
<p>Hystrix过滤器还可以接受可选的 <code>fallbackUri</code> 参数。当前，仅支持 <code>forward:</code> schemed URI。
如果调用了降级，则请求将转发到与URI匹配的控制器。以下示例配置了这种降级：</p>
</div>
<div class="exampleblock">
<div class="title">Example 21. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: hystrix_route
        uri: lb://backing-service:8088
        predicates:
        - Path=/consumingserviceendpoint
        filters:
        - name: Hystrix
          args:
            name: fallbackcmd
            fallbackUri: forward:/incaseoffailureusethis
        - RewritePath=/consumingserviceendpoint, /backingserviceendpoint</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>这将在调用Hystrix降级时转发到 <code>/incaseoffailureusethis</code> URI。
请注意，此示例还演示了（可选）Spring Cloud Netflix Ribbon负载均衡（在目标URI上定义了 <code>lb</code> 前缀）。</p>
</div>
<div class="paragraph">
<p>主要场景是将 <code>fallbackUri</code> 用于网关应用程序中的内部控制器或处理程序。
但是，你还可以将请求重新路由到外部应用程序中的控制器或处理程序，如下所示：</p>
</div>
<div class="exampleblock">
<div class="title">Example 22. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: ingredients
        uri: lb://ingredients
        predicates:
        - Path=//ingredients/**
        filters:
        - name: Hystrix
          args:
            name: fetchIngredients
            fallbackUri: forward:/fallback
      - id: ingredients-fallback
        uri: http://localhost:9994
        predicates:
        - Path=/fallback</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>在此示例中，网关应用程序中没有 <code>fallback</code> 端点或处理程序。但是，另一个应用程序中有一个，注册在 <code><a href="http://localhost:9994" class="bare">http://localhost:9994</a></code> 下。</p>
</div>
<div class="paragraph">
<p>如果将请求转发给降级，则Hystrix网关过滤器还会提供引发该请求的 <code>Throwable</code>。
它作为 <code>ServerWebExchangeUtils.HYSTRIX_EXECUTION_EXCEPTION_ATTR</code> 属性添加到 <code>ServerWebExchange</code>，
你可以在网关应用程序中处理降级时使用该属性。</p>
</div>
<div class="paragraph">
<p>对于外部控制器/处理程序场景，你可以添加带有异常详细信息的头部。你可以在
<a href="#fallback-headers">FallbackHeaders GatewayFilter Factory部分中</a>找到有关此操作的更多信息。</p>
</div>
<div class="paragraph">
<p>你可以使用application properties使用全局默认值或逐条路由配置Hystrix设置（例如超时），如
<a href="https://github.com/Netflix/Hystrix/wiki/Configuration">Hystrix wiki</a>上所述。</p>
</div>
<div class="paragraph">
<p>要为前面显示的示例路由设置五秒钟的超时时间，可以使用以下配置：</p>
</div>
<div class="exampleblock">
<div class="title">Example 23. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">hystrix.command.fallbackcmd.execution.isolation.thread.timeoutInMilliseconds: 5000</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="spring-cloud-circuitbreaker-filter-factory">5.6. Spring Cloud CircuitBreaker <code>GatewayFilter</code> 工厂</h3>
<div class="paragraph">
<p>Spring Cloud CircuitBreaker GatewayFilter工厂使用Spring Cloud CircuitBreaker API将网关路由包装在断路器中。
Spring Cloud CircuitBreaker支持可与Spring Cloud Gateway一起使用的两个库Hystrix和Resilience4J。
由于Netflix已将Hystrix置于仅维护模式，因此建议你使用Resilience4J。</p>
</div>
<div class="paragraph">
<p>要启用Spring Cloud CircuitBreaker过滤器，你需要在类路径上放置
<code>spring-cloud-starter-circuitbreaker-reactor-resilience4j</code> 或
<code>spring-cloud-starter-netflix-hystrix</code>。以下示例配置了一个Spring Cloud CircuitBreaker <code>GatewayFilter</code>：</p>
</div>
<div class="exampleblock">
<div class="title">Example 24. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: circuitbreaker_route
        uri: https://example.org
        filters:
        - CircuitBreaker=myCircuitBreaker</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>要配置断路器，请参阅所使用的底层断路器实现的配置。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://cloud.spring.io/spring-cloud-circuitbreaker/reference/html/spring-cloud-circuitbreaker.html">Resilience4J文档</a></p>
</li>
<li>
<p><a href="https://cloud.spring.io/spring-cloud-netflix/reference/html/">Hystrix文档</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Spring Cloud CircuitBreaker过滤器还可以接受可选的 <code>fallbackUri</code> 参数。
当前，仅支持 <code>forward:</code> schemed URI。如果调用了降级，则请求将转发到与URI匹配的控制器。以下示例配置了这种降级：</p>
</div>
<div class="exampleblock">
<div class="title">Example 25. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: circuitbreaker_route
        uri: lb://backing-service:8088
        predicates:
        - Path=/consumingServiceEndpoint
        filters:
        - name: CircuitBreaker
          args:
            name: myCircuitBreaker
            fallbackUri: forward:/inCaseOfFailureUseThis
        - RewritePath=/consumingServiceEndpoint, /backingServiceEndpoint</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>以下清单在Java中做同样的事情：</p>
</div>
<div class="exampleblock">
<div class="title">Example 26. Application.java</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">@Bean
public RouteLocator routes(RouteLocatorBuilder builder) {
    return builder.routes()
        .route("circuitbreaker_route", r -&gt; r.path("/consumingServiceEndpoint")
            .filters(f -&gt; f.circuitBreaker(c -&gt; c.name("myCircuitBreaker").fallbackUri("forward:/inCaseOfFailureUseThis"))
                .rewritePath("/consumingServiceEndpoint", "/backingServiceEndpoint")).uri("lb://backing-service:8088")
        .build();
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>此示例在调用断路器降级时转发到 <code>/inCaseofFailureUseThis</code> URI。
请注意，此示例还演示了（可选）Spring Cloud Netflix Ribbon负载平衡（由目标URI上的 <code>lb</code> 前缀定义）。</p>
</div>
<div class="paragraph">
<p>主要场景是使用 <code>fallbackUri</code> 在网关应用程序内定义内部控制器或处理程序。
但是，你还可以将请求重新路由到外部应用程序中的控制器或处理程序，如下所示：</p>
</div>
<div class="exampleblock">
<div class="title">Example 27. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: ingredients
        uri: lb://ingredients
        predicates:
        - Path=//ingredients/**
        filters:
        - name: CircuitBreaker
          args:
            name: fetchIngredients
            fallbackUri: forward:/fallback
      - id: ingredients-fallback
        uri: http://localhost:9994
        predicates:
        - Path=/fallback</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>在此示例中，网关应用程序中没有 <code>fallback</code> 端点或处理程序。但是，另一个应用程序中有一个，注册在 <code><a href="http://localhost:9994" class="bare">http://localhost:9994</a></code> 下。</p>
</div>
<div class="paragraph">
<p>如果将请求转发给降级，则Spring Cloud CircuitBreaker网关过滤器还会提供引发该请求的 <code>Throwable</code>。
它作为 <code>ServerWebExchangeUtils.CIRCUITBREAKER_EXECUTION_EXCEPTION_ATTR</code> 属性添加到 <code>ServerWebExchange</code>，
可在网关应用程序中处理降级时使用。</p>
</div>
<div class="paragraph">
<p>对于外部控制器/处理程序场景，你可以添加带有异常详细信息的头部。你可以在
<a href="#fallback-headers">FallbackHeaders GatewayFilter Factory部分中</a>找到有关此操作的更多信息。</p>
</div>
</div>
<div class="sect2">
<h3 id="fallback-headers">5.7. <code>FallbackHeaders</code> <code>GatewayFilter</code> 工厂</h3>
<div class="paragraph">
<p><code>FallbackHeaders</code> 工厂使你可以在转发到外部应用程序中的 <code>fallbackUri</code> 的请求的头部中添加Hystrix或Spring Cloud
CircuitBreaker执行异常详细信息，如以下情况所示：</p>
</div>
<div class="exampleblock">
<div class="title">Example 28. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: ingredients
        uri: lb://ingredients
        predicates:
        - Path=//ingredients/**
        filters:
        - name: CircuitBreaker
          args:
            name: fetchIngredients
            fallbackUri: forward:/fallback
      - id: ingredients-fallback
        uri: http://localhost:9994
        predicates:
        - Path=/fallback
        filters:
        - name: FallbackHeaders
          args:
            executionExceptionTypeHeaderName: Test-Header</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>在此示例中，在运行断路器时发生执行异常之后，该请求将转发到在 <code>localhost:9994</code> 上运行的应用程序中的 <code>fallback</code> 端点或处理程序。
<code>FallbackHeaders</code> 过滤器将具有异常类型，消息和（如果有）root cause异常类型和消息的头部添加到该请求。</p>
</div>
<div class="paragraph">
<p>你可以通过设置以下参数的值（显示其默认值）来覆盖配置中头部的名称：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>executionExceptionTypeHeaderName</code> (<code>"Execution-Exception-Type"</code>)</p>
</li>
<li>
<p><code>executionExceptionMessageHeaderName</code> (<code>"Execution-Exception-Message"</code>)</p>
</li>
<li>
<p><code>rootCauseExceptionTypeHeaderName</code> (<code>"Root-Cause-Exception-Type"</code>)</p>
</li>
<li>
<p><code>rootCauseExceptionMessageHeaderName</code> (<code>"Root-Cause-Exception-Message"</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>有关熔断和网关的更多信息，请参见<a href="#hystrix">Hystrix GatewayFilter工厂部分</a>或
<a href="#spring-cloud-circuitbreaker-filter-factory">Spring Cloud CircuitBreaker工厂部分</a>。</p>
</div>
</div>
<div class="sect2">
<h3 id="__code_maprequestheader_code_code_gatewayfilter_code_工厂">5.8. <code>MapRequestHeader</code> <code>GatewayFilter</code> 工厂</h3>
<div class="paragraph">
<p><code>MapRequestHeader</code> <code>GatewayFilter</code> 工厂采用 <code>fromHeader</code> 和 <code>toHeader</code> 参数。
它创建一个新的命名头（<code>toHeader</code>），然后从传入的HTTP请求中将其值从现有的命名头（<code>fromHeader</code>）中提取出来。
如果输入头部不存在，则过滤器不起作用。如果新的命名头已经存在，则其值将使用新值进行扩充。
以下示例配置一个 <code>MapRequestHeader</code>：</p>
</div>
<div class="exampleblock">
<div class="title">Example 29. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: map_request_header_route
        uri: https://example.org
        filters:
        - MapRequestHeader=Blue, X-Request-Red</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>这会将 <code>X-Request-Red:&lt;values&gt;</code> 头部添加到下游请求中，并带有来自传入HTTP请求的 <code>Blue</code> 头部的更新值。</p>
</div>
</div>
<div class="sect2">
<h3 id="__code_prefixpath_code_code_gatewayfilter_code_工厂">5.9. <code>PrefixPath</code> <code>GatewayFilter</code> 工厂</h3>
<div class="paragraph">
<p><code>PrefixPath</code> <code>GatewayFilter</code> 工厂采用单个 <code>prefix</code> 参数。
以下示例配置 <code>PrefixPath</code> <code>GatewayFilter</code>：</p>
</div>
<div class="exampleblock">
<div class="title">Example 30. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: prefixpath_route
        uri: https://example.org
        filters:
        - PrefixPath=/mypath</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>这会将 <code>/mypath</code> 作为所有匹配请求的路径前缀。因此，对 <code>/hello</code> 的请求将发送到 <code>/mypath/ hello</code>。</p>
</div>
</div>
<div class="sect2">
<h3 id="__code_preservehostheader_code_code_gatewayfilter_code_工厂">5.10. <code>PreserveHostHeader</code> <code>GatewayFilter</code> 工厂</h3>
<div class="paragraph">
<p><code>PreserveHostHeader</code> <code>GatewayFilter</code> 工厂没有参数。
此过滤器设置请求属性，路由过滤器将检查该请求属性，以确定是否应发送原始主机头，而不是由HTTP客户端确定的主机头。
以下示例配置了 <code>PreserveHostHeader</code> <code>GatewayFilter</code>：</p>
</div>
<div class="exampleblock">
<div class="title">Example 31. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: preserve_host_route
        uri: https://example.org
        filters:
        - PreserveHostHeader</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="__code_requestratelimiter_code_code_gatewayfilter_code_工厂">5.11. <code>RequestRateLimiter</code> <code>GatewayFilter</code> 工厂</h3>
<div class="paragraph">
<p><code>RequestRateLimiter</code> <code>GatewayFilter</code> 工厂使用 <code>RateLimiter</code> 实现来确定是否允许继续当前请求。
如果不允许，则会返回 <code>HTTP 429 - Too Many Requests</code> （默认）状态。</p>
</div>
<div class="paragraph">
<p>该过滤器采用可选的 <code>keyResolver</code> 参数和特定于速率限制器的参数（本节稍后介绍）。</p>
</div>
<div class="paragraph">
<p><code>keyResolver</code> 是一个实现 <code>KeyResolver</code> 接口的bean。在配置中，使用SpEL按名称引用bean。
<code>#{@myKeyResolver}</code> 是一个SpEL表达式，它引用一个名为 <code>myKeyResolver</code> 的bean。以下清单显示了 <code>KeyResolver</code> 接口：</p>
</div>
<div class="exampleblock">
<div class="title">Example 32. KeyResolver.java</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">public interface KeyResolver {
    Mono&lt;String&gt; resolve(ServerWebExchange exchange);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><code>KeyResolver</code> 接口允许可插拔策略派生用于限制请求的key。在未来的里程碑版本中，将有一些 <code>KeyResolver</code> 实现。</p>
</div>
<div class="paragraph">
<p><code>KeyResolver</code> 的默认实现是 <code>PrincipalNameKeyResolver</code>，它从 <code>ServerWebExchange</code> 检索 <code>Principal</code> 并调用 <code>Principal.getName()</code>。</p>
</div>
<div class="paragraph">
<p>默认情况下，如果 <code>KeyResolver</code> 找不到key，则拒绝请求。你可以通过设置
<code>spring.cloud.gateway.filter.request-rate-limiter.deny-empty-key</code>（是或否）和
<code>spring.cloud.gateway.filter.request-rate-limiter.empty-key-status-code</code> 属性来调整此行为。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>无法使用“快捷方式”表示法配置 <code>RequestRateLimiter</code>。下面的示例 <em>无效</em>：</p>
</div>
<div class="exampleblock">
<div class="title">Example 33. application.properties</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre># INVALID SHORTCUT CONFIGURATION
spring.cloud.gateway.routes[0].filters[0]=RequestRateLimiter=2, 2, #{@userkeyresolver}</pre>
</div>
</div>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_redis_code_ratelimiter_code">5.11.1. Redis <code>RateLimiter</code></h4>
<div class="paragraph">
<p>Redis的实现基于 <a href="https://stripe.com/blog/rate-limiters">Stripe</a>完成的工作。
它需要使用 <code>spring-boot-starter-data-redis-active</code> Spring Boot启动器。</p>
</div>
<div class="paragraph">
<p>使用的算法是 <a href="https://en.wikipedia.org/wiki/Token_bucket">令牌桶算法</a>。</p>
</div>
<div class="paragraph">
<p><code>redis-rate-limiter.replenishRate</code> 是你希望用户每秒执行多少个请求，而不需要丢弃任何请求。这是令牌桶被填充的速率。</p>
</div>
<div class="paragraph">
<p><code>redis-rate-limiter.burstCapacity</code> 是允许用户在一秒内执行的最大请求数。这是令牌桶可以容纳的令牌数。
将此值设置为零将阻止所有请求。</p>
</div>
<div class="paragraph">
<p>通过在 <code>replenishRate</code> 和 <code>burstCapacity</code> 中设置相同的值可以实现稳定的速率。
通过将 <code>burstCapacity</code> 设置为高于 <code>replenishRate</code>，可以允许临时突发。
在这种情况下，速率限制器需要在两次突发之间保留一段时间（根据 <code>replenishRate</code>），
因为两个连续的突发将导致请求丢弃（<code>HTTP 429 - Too Many Requests</code>）。以下清单配置了 <code>redis-rate-limiter</code>：</p>
</div>
<div class="exampleblock">
<div class="title">Example 34. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: requestratelimiter_route
        uri: https://example.org
        filters:
        - name: RequestRateLimiter
          args:
            redis-rate-limiter.replenishRate: 10
            redis-rate-limiter.burstCapacity: 20</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>以下示例在Java中配置 <code>KeyResolver</code>：</p>
</div>
<div class="exampleblock">
<div class="title">Example 35. Config.java</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">@Bean
KeyResolver userKeyResolver() {
    return exchange -&gt; Mono.just(exchange.getRequest().getQueryParams().getFirst("user"));
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>这定义了每个用户的请求速率限制为10。允许突发20个请求，但是在下一秒中，只有10个请求可用。
<code>KeyResolver</code> 是获取 <code>user</code> 请求参数的简单方法（请注意，不建议在生产环境中使用此参数）。</p>
</div>
<div class="paragraph">
<p>你还可以将速率限制器定义为实现 <code>RateLimiter</code> 接口的Bean。
在配置中，可以使用SpEL按名称引用Bean。<code>#{@myRateLimiter}</code> 是一个SpEL表达式，
它引用名为 <code>myRateLimiter</code> 的bean。以下清单定义了一个速率限制器，该限制器使用前面清单中定义的 <code>KeyResolver</code>：</p>
</div>
<div class="exampleblock">
<div class="title">Example 36. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: requestratelimiter_route
        uri: https://example.org
        filters:
        - name: RequestRateLimiter
          args:
            rate-limiter: "#{@myRateLimiter}"
            key-resolver: "#{@userKeyResolver}"</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="__code_redirectto_code_code_gatewayfilter_code_工厂">5.12. <code>RedirectTo</code> <code>GatewayFilter</code> 工厂</h3>
<div class="paragraph">
<p><code>RedirectTo</code> <code>GatewayFilter</code> 工厂采用两个参数，即 <code>status</code> 和 <code>url</code>。
<code>status</code> 参数应该是300系列重定向HTTP代码，例如301。<code>url</code> 参数应该是有效的URL，这是 <code>Location</code> 头部的值。
下面的清单配置一个 <code>RedirectTo</code> <code>GatewayFilter</code>：</p>
</div>
<div class="exampleblock">
<div class="title">Example 37. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: prefixpath_route
        uri: https://example.org
        filters:
        - RedirectTo=302, https://acme.org</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>这将发送带有 <code>Location:https://acme.org</code> 头部的302状态以执行重定向。</p>
</div>
</div>
<div class="sect2">
<h3 id="__code_removehopbyhopheadersfilter_code_code_gatewayfilter_code_工厂">5.13. <code>RemoveHopByHopHeadersFilter</code> <code>GatewayFilter</code> 工厂</h3>
<div class="paragraph">
<p><code>RemoveHopByHopHeadersFilter</code> <code>GatewayFilter</code> 工厂从转发的请求中删除头部。被删除的头部的默认列表来自
<a href="https://tools.ietf.org/html/draft-ietf-httpbis-p1-messaging-14#section-7.1.3">IETF</a>。</p>
</div>
<div class="ulist">
<div class="title">默认删除的头部是：</div>
<ul>
<li>
<p><code>Connection</code></p>
</li>
<li>
<p><code>Keep-Alive</code></p>
</li>
<li>
<p><code>Proxy-Authenticate</code></p>
</li>
<li>
<p><code>Proxy-Authorization</code></p>
</li>
<li>
<p><code>TE</code></p>
</li>
<li>
<p><code>Trailer</code></p>
</li>
<li>
<p><code>Transfer-Encoding</code></p>
</li>
<li>
<p><code>Upgrade</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>要更改已删除的头部，请将 <code>spring.cloud.gateway.filter.remove-non-proxy-headers.headers</code> 属性设置为要删除的头部名称列表。</p>
</div>
</div>
<div class="sect2">
<h3 id="__code_removerequestheader_code_code_gatewayfilter_code_工厂">5.14. <code>RemoveRequestHeader</code> <code>GatewayFilter</code> 工厂</h3>
<div class="paragraph">
<p><code>RemoveRequestHeader</code> <code>GatewayFilter</code> 工厂带有一个 <code>name</code> 参数。它是要删除的请求头名称。
下面的清单配置一个 <code>RemoveRequestHeader</code> <code>GatewayFilter</code>：</p>
</div>
<div class="exampleblock">
<div class="title">Example 38. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: removerequestheader_route
        uri: https://example.org
        filters:
        - RemoveRequestHeader=X-Request-Foo</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>这将删除 <code>X-Request-Foo</code> 头部，然后将其发送到下游。</p>
</div>
</div>
<div class="sect2">
<h3 id="__code_removeresponseheader_code_code_gatewayfilter_code_工厂">5.15. <code>RemoveResponseHeader</code> <code>GatewayFilter</code> 工厂</h3>
<div class="paragraph">
<p><code>RemoveResponseHeader</code> <code>GatewayFilter</code> 工厂采用 <code>name</code> 参数。它是要删除的响应头名称。
下面的清单配置一个 <code>RemoveResponseHeader</code> <code>GatewayFilter</code>：</p>
</div>
<div class="exampleblock">
<div class="title">Example 39. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: removeresponseheader_route
        uri: https://example.org
        filters:
        - RemoveResponseHeader=X-Response-Foo</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>这将从响应中删除 <code>X-Response-Foo</code> 头部，然后将其返回到网关客户端。</p>
</div>
<div class="paragraph">
<p>要删除任何类型的敏感头部，应为可能要为其配置的任何路由配置此过滤器。
另外，你可以使用 <code>spring.cloud.gateway.default-filters</code> 一次配置此过滤器，并将其应用于所有路由。</p>
</div>
</div>
<div class="sect2">
<h3 id="__code_removerequestparameter_code_code_gatewayfilter_code_工厂">5.16. <code>RemoveRequestParameter</code> <code>GatewayFilter</code> 工厂</h3>
<div class="paragraph">
<p><code>RemoveRequestParameter</code> <code>GatewayFilter</code> 工厂采用 <code>name</code> 参数。它是要删除的查询参数的名称。
以下示例配置一个 <code>RemoveRequestParameter</code> <code>GatewayFilter</code>：</p>
</div>
<div class="exampleblock">
<div class="title">Example 40. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: removerequestparameter_route
        uri: https://example.org
        filters:
        - RemoveRequestParameter=red</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>这将删除 <code>red</code> 参数，然后再将其发送到下游。</p>
</div>
</div>
<div class="sect2">
<h3 id="__code_rewritepath_code_code_gatewayfilter_code_工厂">5.17. <code>RewritePath</code> <code>GatewayFilter</code> 工厂</h3>
<div class="paragraph">
<p><code>RewritePath</code> <code>GatewayFilter</code> 工厂采用路径 <code>regexp</code> 参数和 <code>replacement</code> 参数。
这使用Java正则表达式提供了一种灵活的方式来重写请求路径。
以下清单配置了 <code>RewritePath</code> <code>GatewayFilter</code>：</p>
</div>
<div class="exampleblock">
<div class="title">Example 41. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: rewritepath_route
        uri: https://example.org
        predicates:
        - Path=/foo/**
        filters:
        - RewritePath=/red(?&lt;segment&gt;/?.*), $\{segment}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>对于 <code>/red/blue</code> 的请求路径，这会在发出下游请求之前将路径设置为 <code>/blue</code>。请注意，由于YAML规范，应将 <code>$</code> 替换为 <code>$\</code>。</p>
</div>
</div>
<div class="sect2">
<h3 id="__code_rewritelocationresponseheader_code_code_gatewayfilter_code_工厂">5.18. <code>RewriteLocationResponseHeader</code> <code>GatewayFilter</code> 工厂</h3>
<div class="paragraph">
<p><code>RewriteLocationResponseHeader</code> <code>GatewayFilter</code> 工厂通常会修改 <code>Location</code> 响应头的值，以摆脱特定于后端的详细信息。
它需要 <code>stripVersionMode</code>，<code>locationHeaderName</code>，<code>hostValue</code> 和 <code>protocolRegex</code> 参数。
下面的清单配置一个 <code>RewriteLocationResponseHeader</code> <code>GatewayFilter</code>：</p>
</div>
<div class="exampleblock">
<div class="title">Example 42. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: rewritelocationresponseheader_route
        uri: http://example.org
        filters:
        - RewriteLocationResponseHeader=AS_IN_REQUEST, Location, ,</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>例如，对于 <code>POST <a href="https://api.example.com/some/object/name" class="bare">https://api.example.com/some/object/name</a></code> 的请求，<code><a href="https://object-service.prod.example.net/v2/some/object/id" class="bare">https://object-service.prod.example.net/v2/some/object/id</a></code>
的 <code>Location</code> 响应头值被重写为 <code><a href="https://api.example.com/some/object/id" class="bare">https://api.example.com/some/object/id</a></code>。</p>
</div>
<div class="paragraph">
<p><code>stripVersionMode</code> 参数具有以下可能的值：<code>NEVER_STRIP</code>，<code>AS_IN_REQUEST</code>（默认值）和 <code>ALWAYS_STRIP</code>。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>NEVER_STRIP</code>: 即使原始请求路径不包含任何版本，也不会剥离该版本。</p>
</li>
<li>
<p><code>AS_IN_REQUEST</code>: 仅当原始请求路径不包含版本时，才剥离版本。</p>
</li>
<li>
<p><code>ALWAYS_STRIP</code>: 即使原始请求路径包含版本，也始终会剥离该版本。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>hostValue</code> 参数（如果提供）用于替换 <code>Location</code> 响应头的 <code>host:port</code> 部分。如果未提供，则使用 <code>Host</code> 请求头的值。</p>
</div>
<div class="paragraph">
<p><code>protocolRegex</code> 参数必须是有效的正则表达式 <code>String</code>，协议名称与之匹配。如果不匹配，则过滤器不执行任何操作。
默认值为 <code>http|https|ftp|ftps</code>。</p>
</div>
</div>
<div class="sect2">
<h3 id="__code_rewriteresponseheader_code_code_gatewayfilter_code_工厂">5.19. <code>RewriteResponseHeader</code> <code>GatewayFilter</code> 工厂</h3>
<div class="paragraph">
<p><code>RewriteResponseHeader</code> <code>GatewayFilter`工厂采用 `name</code>, <code>regexp</code> 和 <code>replacement</code> 参数。
它使用Java正则表达式以灵活的方式重写响应头值。
以下示例配置 <code>RewriteResponseHeader</code> <code>GatewayFilter</code>：</p>
</div>
<div class="exampleblock">
<div class="title">Example 43. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: rewriteresponseheader_route
        uri: https://example.org
        filters:
        - RewriteResponseHeader=X-Response-Red, , password=[^&amp;]+, password=***</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>对于 <code>/42?user=ford&amp;password=omg!what&amp;flag=true</code> 的头部值，在发出下游请求后将其设置为 <code>/42?user=ford&amp;password=***&amp;flag=true</code>。
由于YAML规范，必须使用 <code>$\</code> 表示 <code>$</code>。</p>
</div>
</div>
<div class="sect2">
<h3 id="__code_savesession_code_code_gatewayfilter_code_工厂">5.20. <code>SaveSession</code> <code>GatewayFilter</code> 工厂</h3>
<div class="paragraph">
<p><code>SaveSession</code> <code>GatewayFilter</code> 工厂在向下游转发调用 <em>之前</em> 强制执行 <code>WebSession::save</code> 操作。
当将诸如 <a href="https://projects.spring.io/spring-session/">Spring Session</a>之类的数据与惰性数据存储一起使用时，
这特别有用，你需要确保会话状态在进行转发调用之前已保存。
以下示例配置 <code>SaveSession</code> <code>GatewayFilter</code>：</p>
</div>
<div class="exampleblock">
<div class="title">Example 44. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: save_session
        uri: https://example.org
        predicates:
        - Path=/foo/**
        filters:
        - SaveSession</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>如果你将 <a href="https://projects.spring.io/spring-security/">Spring Security</a>与Spring Session集成在一起，
并想确保安全性详细信息已转发到远程进程，那么这一点至关重要。</p>
</div>
</div>
<div class="sect2">
<h3 id="__code_secureheaders_code_code_gatewayfilter_code_工厂">5.21. <code>SecureHeaders</code> <code>GatewayFilter</code> 工厂</h3>
<div class="paragraph">
<p>根据 <a href="https://blog.appcanary.com/2017/http-security-headers.html">此博客文章</a>中的建议，<code>SecureHeaders</code>
<code>GatewayFilter</code> 工厂将许多头部添加到响应中。</p>
</div>
<div class="paragraph">
<p>添加了以下头部（以其默认值显示）：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>X-Xss-Protection:1 (mode=block</code>)</p>
</li>
<li>
<p><code>Strict-Transport-Security (max-age=631138519</code>)</p>
</li>
<li>
<p><code>X-Frame-Options (DENY)</code></p>
</li>
<li>
<p><code>X-Content-Type-Options (nosniff)</code></p>
</li>
<li>
<p><code>Referrer-Policy (no-referrer)</code></p>
</li>
<li>
<p><code>Content-Security-Policy (default-src 'self' https:; font-src 'self' https: data:; img-src 'self' https: data:; object-src 'none'; script-src https:; style-src 'self' https: 'unsafe-inline)'</code></p>
</li>
<li>
<p><code>X-Download-Options (noopen)</code></p>
</li>
<li>
<p><code>X-Permitted-Cross-Domain-Policies (none)</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>要更改默认值，请在 <code>spring.cloud.gateway.filter.secure-headers</code> 命名空间中设置适当的属性。可以使用以下属性：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>xss-protection-header</code></p>
</li>
<li>
<p><code>strict-transport-security</code></p>
</li>
<li>
<p><code>x-frame-options</code></p>
</li>
<li>
<p><code>x-content-type-options</code></p>
</li>
<li>
<p><code>referrer-policy</code></p>
</li>
<li>
<p><code>content-security-policy</code></p>
</li>
<li>
<p><code>x-download-options</code></p>
</li>
<li>
<p><code>x-permitted-cross-domain-policies</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>要禁用默认值，请设置 <code>spring.cloud.gateway.filter.secure-headers.disable</code> 属性，并用逗号分隔值。以下示例显示了如何执行此操作：</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>spring.cloud.gateway.filter.secure-headers.disable=x-frame-options,strict-transport-security</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
需要使用secure头部的小写全名来禁用它。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="__code_setpath_code_code_gatewayfilter_code_工厂">5.22. <code>SetPath</code> <code>GatewayFilter</code> 工厂</h3>
<div class="paragraph">
<p><code>SetPath</code> <code>GatewayFilter</code> 工厂采用路径 <code>template</code> 参数。
通过允许路径的模板段，它提供了一种操作请求路径的简单方法。这使用了Spring Framework中的URI模板。允许多个匹配段。
以下示例配置一个 <code>SetPath</code> <code>GatewayFilter</code>：</p>
</div>
<div class="exampleblock">
<div class="title">Example 45. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: setpath_route
        uri: https://example.org
        predicates:
        - Path=/red/{segment}
        filters:
        - SetPath=/{segment}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>对于 <code>/red/blue</code> 的请求路径，这会在发出下游请求之前将路径设置为 <code>/blue</code>。</p>
</div>
</div>
<div class="sect2">
<h3 id="__code_setrequestheader_code_code_gatewayfilter_code_工厂">5.23. <code>SetRequestHeader</code> <code>GatewayFilter</code> 工厂</h3>
<div class="paragraph">
<p><code>SetRequestHeader</code> <code>GatewayFilter</code> 工厂采用 <code>name</code> 和 <code>value</code> 参数。
下面的清单配置了 <code>SetRequestHeader</code> <code>GatewayFilter</code>：</p>
</div>
<div class="exampleblock">
<div class="title">Example 46. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: setrequestheader_route
        uri: https://example.org
        filters:
        - SetRequestHeader=X-Request-Red, Blue</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>该 <code>GatewayFilter</code> 用给定名称替换（而不是添加）所有头部。因此，如果下游服务器响应 <code>X-Request-Red:1234</code>，
则将其替换为 <code>X-Request-Red:Blue</code>，这是下游服务将收到的内容。</p>
</div>
<div class="paragraph">
<p><code>SetRequestHeader</code> 知道用于匹配路径或主机的URI变量。URI变量可以在值中使用，并在运行时展开。
以下示例配置使用变量的 <code>SetRequestHeader</code> <code>GatewayFilter</code>：</p>
</div>
<div class="exampleblock">
<div class="title">Example 47. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: setrequestheader_route
        uri: https://example.org
        predicates:
        - Host: {segment}.myhost.org
        filters:
        - SetRequestHeader=foo, bar-{segment}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="__code_setresponseheader_code_code_gatewayfilter_code_工厂">5.24. <code>SetResponseHeader</code> <code>GatewayFilter</code> 工厂</h3>
<div class="paragraph">
<p><code>SetResponseHeader</code> <code>GatewayFilter</code> 工厂采用 <code>name</code> 和 <code>value</code> 参数。
下面的清单配置了 <code>SetResponseHeader</code> <code>GatewayFilter</code>：</p>
</div>
<div class="exampleblock">
<div class="title">Example 48. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: setresponseheader_route
        uri: https://example.org
        filters:
        - SetResponseHeader=X-Response-Red, Blue</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>该 <code>GatewayFilter</code> 用给定名称替换（而不是添加）所有头部。所以，如果下游服务器响应 <code>X-Request-Red:1234</code>，
则将其替换为 <code>X-Request-Red:Blue</code>，这是网关客户端将收到的内容。</p>
</div>
<div class="paragraph">
<p><code>SetResponseHeader</code> 知道用于匹配路径或主机的URI变量。URI变量可用于该值，并将在运行时展开。
以下示例配置使用变量的 <code>SetResponseHeader</code> <code>GatewayFilter</code>：</p>
</div>
<div class="exampleblock">
<div class="title">Example 49. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: setresponseheader_route
        uri: https://example.org
        predicates:
        - Host: {segment}.myhost.org
        filters:
        - SetResponseHeader=foo, bar-{segment}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="__code_setstatus_code_code_gatewayfilter_code_工厂">5.25. <code>SetStatus</code> <code>GatewayFilter</code> 工厂</h3>
<div class="paragraph">
<p><code>SetStatus</code> <code>GatewayFilter</code> 工厂采用单个参数 <code>status</code>。它必须是有效的Spring <code>HttpStatus</code>。
它可以是整数值 <code>404</code> 或枚举的字符串表示形式：<code>NOT_FOUND</code>。
下面的清单配置一个 <code>SetStatus</code> <code>GatewayFilter</code>：</p>
</div>
<div class="exampleblock">
<div class="title">Example 50. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: setstatusstring_route
        uri: https://example.org
        filters:
        - SetStatus=BAD_REQUEST
      - id: setstatusint_route
        uri: https://example.org
        filters:
        - SetStatus=401</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>无论哪种情况，响应的HTTP状态都设置为401。</p>
</div>
<div class="paragraph">
<p>你可以将 <code>SetStatus</code> <code>GatewayFilter</code> 配置为在响应头中返回代理请求的原始HTTP状态码。
如果使用以下属性配置头部，则会将其添加到响应中：</p>
</div>
<div class="exampleblock">
<div class="title">Example 51. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      set-status:
        original-status-header-name: original-http-status</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="__code_stripprefix_code_code_gatewayfilter_code_工厂">5.26. <code>StripPrefix</code> <code>GatewayFilter</code> 工厂</h3>
<div class="paragraph">
<p><code>StripPrefix</code> <code>GatewayFilter</code> 工厂采用一个 <code>parts</code> 参数。<code>parts</code> 参数指示在向下游发送请求之前要从请求中剥离的路径部分的数量。
下面的清单配置一个 <code>StripPrefix</code> <code>GatewayFilter</code>：</p>
</div>
<div class="exampleblock">
<div class="title">Example 52. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: nameRoot
        uri: https://nameservice
        predicates:
        - Path=/name/**
        filters:
        - StripPrefix=2</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>当通过网关向 <code>/name/blue/red</code> 发出请求时，向 <code>nameservice</code> 发出的请求看起来就像 <code><a href="https://nameservice/red" class="bare">https://nameservice/red</a></code>。</p>
</div>
</div>
<div class="sect2">
<h3 id="_retry_code_gatewayfilter_code_工厂">5.27. Retry <code>GatewayFilter</code> 工厂</h3>
<div class="paragraph">
<p>重试 <code>GatewayFilter</code> 工厂支持以下参数：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>retries</code>: 应尝试的重试次数。</p>
</li>
<li>
<p><code>statuses</code>: 使用 <code>org.springframework.http.HttpStatus</code> 表示的应重试的HTTP状态码。</p>
</li>
<li>
<p><code>methods</code>: 使用 <code>org.springframework.http.HttpMethod</code> 表示的应重试的HTTP方法。</p>
</li>
<li>
<p><code>series</code>: 使用 <code>org.springframework.http.HttpStatus.Series</code> 表示的要重试的状态码系列。</p>
</li>
<li>
<p><code>exceptions</code>: 应该重试的抛出异常列表。</p>
</li>
<li>
<p><code>backoff</code>: 重试配置的指数补偿。
在 <code>firstBackoff * (factor ^ n)</code> 的退避间隔之后执行重试，其中 <code>n</code> 是迭代次数。
如果配置了 <code>maxBackoff</code>，则将应用的最大退避间隔限制为 <code>maxBackoff</code>。
如果 <code>basedOnPreviousValue</code> 为 <code>true</code>，则使用 <code>prevBackoff * factor</code> 计算退避量。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>如果启用，下面是 <code>Retry</code> 过滤器的默认设置:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>retries</code>: 3次</p>
</li>
<li>
<p><code>series</code>: 5XX 系列</p>
</li>
<li>
<p><code>methods</code>: GET 方法</p>
</li>
<li>
<p><code>exceptions</code>: <code>IOException</code> 和 <code>TimeoutException</code></p>
</li>
<li>
<p><code>backoff</code>: 禁用</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>下面的清单配置一个重试 <code>GatewayFilter</code>：</p>
</div>
<div class="exampleblock">
<div class="title">Example 53. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: retry_test
        uri: http://localhost:8080/flakey
        predicates:
        - Host=*.retry.com
        filters:
        - name: Retry
          args:
            retries: 3
            statuses: BAD_GATEWAY
            backoff:
              firstBackoff: 10ms
              maxBackoff: 50ms
              factor: 2
              basedOnPreviousValue: false</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
重试过滤器当前不支持使用正文进行重试（例如：对于使用正文的POST或PUT请求）。
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
当将重试过滤器与带有 <code>forward:</code> 前缀的URL一起使用时，应仔细编写目标端点，以便在出现错误时，它不会执行任何可能导致将响应发送到客户端并提交的操作。
例如：如果目标端点是带注解的控制器，则目标控制器方法不应返回带有错误状态码的 <code>ResponseEntity</code>。
相反，它应该引发 <code>Exception</code> 或发出错误信号（例如：通过 <code>Mono.error(ex)</code> 返回值），可以通过重试配置的重试过滤器来处理该值。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="__code_requestsize_code_code_gatewayfilter_code_工厂">5.28. <code>RequestSize</code> <code>GatewayFilter</code> 工厂</h3>
<div class="paragraph">
<p>当请求大小大于允许的限制时，<code>RequestSize</code> <code>GatewayFilter</code> 工厂可以限制请求到达下游服务。
过滤器采用 <code>RequestSize</code> 参数。它是允许的请求大小限制，以字节为单位。
下面的清单配置一个 <code>RequestSize</code> <code>GatewayFilter</code>：</p>
</div>
<div class="exampleblock">
<div class="title">Example 54. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: request_size_route
        uri: http://localhost:8080/upload
        predicates:
        - Path=/upload
        filters:
        - name: RequestSize
          args:
            maxSize: 5000000</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>当请求由于大小而被拒绝时，<code>RequestSize</code> <code>GatewayFilter</code> 工厂将响应状态设置为 <code>413 Payload Too Large</code>，
并带有附加的报头 <code>errorMessage</code>。以下示例显示了这样的 <code>errorMessage</code>：</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>errorMessage` : `Request size is larger than permissible limit. Request size is 6.0 MB where permissible limit is 5.0 MB</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
如果未在路由定义中提供过滤器参数，则默认请求大小将设置为5 MB。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_修改请求体_code_gatewayfilter_code_工厂">5.29. 修改请求体 <code>GatewayFilter</code> 工厂</h3>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
该过滤器被认为是BETA，API将来可能会更改。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>你可以使用此过滤器在网关将请求体发送到下游之前修改请求体。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
只能使用Java DSL来配置此过滤器。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>以下清单显示了如何修改请求体 <code>GatewayFilter</code>：</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">@Bean
public RouteLocator routes(RouteLocatorBuilder builder) {
    return builder.routes()
        .route("rewrite_request_obj", r -&gt; r.host("*.rewriterequestobj.org")
            .filters(f -&gt; f.prefixPath("/httpbin")
                .modifyRequestBody(String.class, Hello.class, MediaType.APPLICATION_JSON_VALUE,
                    (exchange, s) -&gt; return Mono.just(new Hello(s.toUpperCase())))).uri(uri))
        .build();
}

static class Hello {
    String message;

    public Hello() { }

    public Hello(String message) {
        this.message = message;
    }

    public String getMessage() {
        return message;
    }

    public void setMessage(String message) {
        this.message = message;
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_修改响应体_code_gatewayfilter_code_工厂">5.30. 修改响应体 <code>GatewayFilter</code> 工厂</h3>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
该过滤器被认为是BETA，API将来可能会更改。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>你可以使用此过滤器在将响应体发送回客户端之前对其进行修改。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
只能使用Java DSL来配置此过滤器。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>以下清单显示了如何修改响应体 <code>GatewayFilter</code>：</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">@Bean
public RouteLocator routes(RouteLocatorBuilder builder) {
    return builder.routes()
        .route("rewrite_response_upper", r -&gt; r.host("*.rewriteresponseupper.org")
            .filters(f -&gt; f.prefixPath("/httpbin")
                .modifyResponseBody(String.class, String.class,
                    (exchange, s) -&gt; Mono.just(s.toUpperCase()))).uri(uri)
        .build();
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_默认过滤器">5.31. 默认过滤器</h3>
<div class="paragraph">
<p>要添加过滤器并将其应用于所有路由，可以使用 <code>spring.cloud.gateway.default-filters</code>。
此属性可配置为过滤器列表。以下清单定义了一组默认过滤器：</p>
</div>
<div class="exampleblock">
<div class="title">Example 55. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      default-filters:
      - AddResponseHeader=X-Response-Default-Red, Default-Blue
      - PrefixPath=/httpbin</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_全局过滤器">6. 全局过滤器</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>GlobalFilter</code> 接口具有与 <code>GatewayFilter</code> 相同的签名。这些是特殊过滤器，有条件地应用于所有路由。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
此接口及其用法可能会在将来的里程碑版本中更改。
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="gateway-combined-global-filter-and-gatewayfilter-ordering">6.1. 全局过滤器和 <code>GatewayFilter</code> 组合的顺序</h3>
<div class="paragraph">
<p>当请求与路由匹配时，过滤Web处理程序会将 <code>GlobalFilter</code> 的所有实例和 <code>GatewayFilter</code> 的所有特定于路由的实例添加到过滤器链中。
该组合的过滤器链由 <code>org.springframework.core.Ordered</code> 接口排序，你可以通过实现 <code>getOrder()</code> 方法进行设置。</p>
</div>
<div class="paragraph">
<p>由于Spring Cloud Gateway区分了过滤器逻辑执行的“<code>pre</code>”阶段和“<code>post</code>”阶段（请参阅<a href="#gateway-how-it-works">工作原理</a>），
因此具有最高优先级的过滤器是“<code>pre</code>”阶段中的第一个筛选器，是“<code>post</code>”阶段中的最后一个过滤器。</p>
</div>
<div class="paragraph">
<p>以下清单配置了一个过滤器链：</p>
</div>
<div class="exampleblock">
<div class="title">Example 56. ExampleConfiguration.java</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">@Bean
public GlobalFilter customFilter() {
    return new CustomGlobalFilter();
}

public class CustomGlobalFilter implements GlobalFilter, Ordered {

    @Override
    public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        log.info("custom global filter");
        return chain.filter(exchange);
    }

    @Override
    public int getOrder() {
        return -1;
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_forward路由过滤器">6.2. Forward路由过滤器</h3>
<div class="paragraph">
<p><code>ForwardRoutingFilter</code> 在交换属性 <code>ServerWebExchangeUtils.GATEWAY_REQUEST_URL_ATTR</code> 中查找URI。
如果URL具有 <code>forward</code> scheme（例如：<code>forward:///localendpoint</code>），则它将使用Spring <code>DispatcherHandler</code> 来处理请求。
请求URL的路径部分被转发URL中的路径覆盖。
未经修改的原始URL会附加到 <code>ServerWebExchangeUtils.GATEWAY_ORIGINAL_REQUEST_URL_ATTR</code> 属性中的列表中。</p>
</div>
</div>
<div class="sect2">
<h3 id="__code_loadbalancerclient_code_过滤器">6.3. <code>LoadBalancerClient</code> 过滤器</h3>
<div class="paragraph">
<p><code>LoadBalancerClientFilter</code> 在交换属性 <code>ServerWebExchangeUtils.GATEWAY_REQUEST_URL_ATTR</code> 中查找URI。
如果URL的scheme为 <code>lb</code>（例如：<code>lb://myservice</code>），它将使用Spring Cloud <code>LoadBalancerClient</code> 将名称
（在本例中为 <code>myservice</code>）解析为实际的主机和端口，并在同一属性中替换URI。
未经修改的原始URL会附加到 <code>ServerWebExchangeUtils.GATEWAY_ORIGINAL_REQUEST_URL_ATTR</code> 属性中的列表中。
过滤器还会在 <code>ServerWebExchangeUtils.GATEWAY_SCHEME_PREFIX_ATTR</code> 属性中查找其是否等于 <code>lb</code>。如果是，则应用相同的规则。
下面的清单配置一个 <code>LoadBalancerClientFilter</code>：</p>
</div>
<div class="exampleblock">
<div class="title">Example 57. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: myRoute
        uri: lb://service
        predicates:
        - Path=/service/**</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
默认情况下，当在 <code>LoadBalancer</code> 中找不到服务实例时，将返回 <code>503</code>。你可以通过设置
<code>spring.cloud.gateway.loadbalancer.use404=true</code> 将网关配置为返回404。
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
从 <code>LoadBalancer</code> 返回的 <code>ServiceInstance</code> 的 <code>isSecure</code> 值将覆盖对网关的请求中指定的scheme。
例如：如果请求通过HTTPS进入网关，但 <code>ServiceInstance</code> 指示它不安全，则下游请求将通过HTTP发出。
相反的情况也可以适用。但是，如果在网关配置中为路由指定了 <code>GATEWAY_SCHEME_PREFIX_ATTR</code>，
则会删除前缀，并且路由URL产生的scheme将覆盖 <code>ServiceInstance</code> 配置。
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<code>LoadBalancerClientFilter</code> 在底层使用了阻塞的ribbon <code>LoadBalancerClient</code>。
我们建议你<a href="#reactive-loadbalancer-client-filter">改用 <code>ReactiveLoadBalancerClientFilter</code></a>。
你可以通过将 <code>spring.cloud.loadbalancer.ribbon.enabled</code> 的值设置为 <code>false</code> 来切换到它。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="reactive-loadbalancer-client-filter">6.4. The <code>ReactiveLoadBalancerClientFilter</code></h3>
<div class="paragraph">
<p><code>ReactiveLoadBalancerClientFilter</code> 在名为 <code>ServerWebExchangeUtils.GATEWAY_REQUEST_URL_ATTR</code> 的交换属性中查找URI。
如果URL具有 <code>lb</code> scheme（例如：<code>lb://myservice</code>），它将使用Spring Cloud <code>ReactorLoadBalancer</code> 将名称
（在本示例中为 <code>myservice</code>）解析为实际的主机和端口，并替换同一属性中的URI。
未经修改的原始URL会附加到 <code>ServerWebExchangeUtils.GATEWAY_ORIGINAL_REQUEST_URL_ATTR</code> 属性中的列表中。
过滤器还会在 <code>ServerWebExchangeUtils.GATEWAY_SCHEME_PREFIX_ATTR</code> 属性中查找其是否等于 <code>lb</code>。如果是，则应用相同的规则。
以下清单配置了 <code>ReactiveLoadBalancerClientFilter</code>：</p>
</div>
<div class="exampleblock">
<div class="title">Example 58. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: myRoute
        uri: lb://service
        predicates:
        - Path=/service/**</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
默认情况下，当 <code>ReactorLoadBalancer</code> 无法找到服务实例时，将返回 <code>503</code>。你可以通过设置
<code>spring.cloud.gateway.loadbalancer.use404=true</code> 将网关配置为返回 <code>404</code>。
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
从 <code>ReactiveLoadBalancerClientFilter</code> 返回的 <code>ServiceInstance</code> 的 <code>isSecure</code> 值将覆盖对网关的请求中指定的scheme。
例如：如果请求通过HTTPS进入网关，但 <code>ServiceInstance</code> 指示它不安全，则下游请求将通过HTTP发出。
相反的情况也可以适用。但是，如果在网关配置中为路由指定了 <code>GATEWAY_SCHEME_PREFIX_ATTR</code>，则会删除前缀，
并且路由URL产生的schema将覆盖 <code>ServiceInstance</code> 配置。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_netty路由过滤器">6.5. Netty路由过滤器</h3>
<div class="paragraph">
<p>如果位于 <code>ServerWebExchangeUtils.GATEWAY_REQUEST_URL_ATTR</code> 交换属性中的URL具有http或https schema，
则将运行Netty路由过滤器。它使用Netty <code>HttpClient</code> 发出下游代理请求。
响应被放入 <code>ServerWebExchangeUtils.CLIENT_RESPONSE_ATTR</code> 交换属性中，以供以后的过滤器使用。
（还有一个实验性的 <code>WebClientHttpRoutingFilter</code>，它执行相同的功能，但不需要Netty。）</p>
</div>
</div>
<div class="sect2">
<h3 id="_netty写响应过滤器">6.6. Netty写响应过滤器</h3>
<div class="paragraph">
<p>如果 <code>ServerWebExchangeUtils.CLIENT_RESPONSE_ATTR</code> 交换属性中存在Netty <code>HttpClientResponse</code>，则 <code>NettyWriteResponseFilter</code> 将运行。
它在所有其他过滤器完成后运行，并将代理响应写回到网关客户端响应。
（还有一个实验性的 <code>WebClientWriteResponseFilter</code> 执行相同的功能，但不需要Netty。）</p>
</div>
</div>
<div class="sect2">
<h3 id="__code_routetorequesturl_code_过滤器">6.7. <code>RouteToRequestUrl</code> 过滤器</h3>
<div class="paragraph">
<p>如果 <code>ServerWebExchangeUtils.GATEWAY_ROUTE_ATTR</code> 交换属性中有一个 <code>Route</code> 对象，则 <code>RouteToRequestUrlFilter</code> 将运行。
它基于请求URI创建一个新URI，但使用 <code>Route</code> 对象的URI属性进行更新。
新的URI放置在 <code>ServerWebExchangeUtils.GATEWAY_REQUEST_URL_ATTR</code> 交换属性中。</p>
</div>
<div class="paragraph">
<p>如果URI具有scheme前缀，例如：<code>lb:ws://serviceid</code>，则将从URI中剥离 <code>lb</code> scheme，并将其放置在
<code>ServerWebExchangeUtils.GATEWAY_SCHEME_PREFIX_ATTR</code> 中，以供稍后在过滤器链中使用。</p>
</div>
</div>
<div class="sect2">
<h3 id="_websocket路由过滤器">6.8. Websocket路由过滤器</h3>
<div class="paragraph">
<p>如果位于 <code>ServerWebExchangeUtils.GATEWAY_REQUEST_URL_ATTR</code> 交换属性中的URL具有 <code>ws</code> 或 <code>wss</code> schema，
则将运行websocket路由过滤器。它使用Spring WebSocket基础设施向下游转发websocket请求。</p>
</div>
<div class="paragraph">
<p>你可以通过为URI加上 <code>lb</code> 前缀来均衡websocket的负载，例如：<code>lb:ws://serviceid</code>。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
如果将 <a href="https://github.com/sockjs">SockJS</a>用作常规HTTP的降级，则应配置常规HTTP路由以及websocket路由。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>下面的清单配置了一个websocket路由过滤器：</p>
</div>
<div class="exampleblock">
<div class="title">Example 59. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      # SockJS route
      - id: websocket_sockjs_route
        uri: http://localhost:3001
        predicates:
        - Path=/websocket/info/**
      # Normal Websocket route
      - id: websocket_route
        uri: ws://localhost:3001
        predicates:
        - Path=/websocket/**</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_网关指标过滤器">6.9. 网关指标过滤器</h3>
<div class="paragraph">
<p>要启用网关指标，请添加 <code>spring-boot-starter-actuator</code> 作为项目依赖项。
然后，默认情况下，只要未将 <code>spring.cloud.gateway.metrics.enabled</code> 属性设置为 <code>false</code>，网关指标过滤器就会运行。
该过滤器添加了一个带有以下tag且名为 <code>gateway.requests</code> 的计时器度量标准：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>routeId</code>: 路由ID.</p>
</li>
<li>
<p><code>routeUri</code>: API路由到的URI。</p>
</li>
<li>
<p><code>outcome</code>: 结果，按 <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/http/HttpStatus.Series.html">HttpStatus.Series</a>分类。</p>
</li>
<li>
<p><code>status</code>: 返回给客户端的请求的HTTP状态。</p>
</li>
<li>
<p><code>httpStatusCode</code>: 返回给客户端的请求的HTTP状态码。</p>
</li>
<li>
<p><code>httpMethod</code>: 用于请求的HTTP方法。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>然后，可以从 <code>/actuator/metrics/gateway.requests</code> 中抓取这些度量标准，并且可以轻松地将它们与Prometheus集成以创建
<a href="images/spring-cloud-gateway/gateway-grafana-dashboard.jpeg">Grafana</a>
<a href="spring-cloud-gateway/gateway-grafana-dashboard.json">dashboard</a>。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
要启用prometheus端点，请添加 <code>micrometer-registry-prometheus</code> 作为项目依赖项。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_将交换标记为已路由">6.10. 将交换标记为已路由</h3>
<div class="paragraph">
<p>网关路由 <code>ServerWebExchange</code> 之后，通过将 <code>gatewayAlreadyRouted</code> 添加到交换属性，将交换标记为“<code>routed</code>”。
将请求标记为已路由后，其他路由过滤器将不会再次路由请求，实质上会跳过该过滤器。
你可以使用以下便捷方法将交换标记为已路由或检查交换是否已路由。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ServerWebExchangeUtils.isAlreadyRouted</code> 接受一个 <code>ServerWebExchange</code> 对象，并检查它是否已被“<code>routed</code>”。</p>
</li>
<li>
<p><code>ServerWebExchangeUtils.setAlreadyRouted</code> 接受一个 <code>ServerWebExchange</code> 对象，并将其标记为“<code>routed</code>”。</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tls和ssl">7. TLS和SSL</h2>
<div class="sectionbody">
<div class="paragraph">
<p>网关可以通过常规的Spring服务器配置监听HTTPS上的请求。以下示例显示了如何执行此操作：</p>
</div>
<div class="exampleblock">
<div class="title">Example 60. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">server:
  ssl:
    enabled: true
    key-alias: scg
    key-store-password: scg1234
    key-store: classpath:scg-keystore.p12
    key-store-type: PKCS12</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>你可以将网关routes路由到HTTP和HTTPS后端。
如果要路由到HTTPS后端，则可以使用以下配置将网关配置为信任所有下游证书：</p>
</div>
<div class="exampleblock">
<div class="title">Example 61. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      httpclient:
        ssl:
          useInsecureTrustManager: true</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>不可在生产环境使用不安全的信任管理器。
对于生产部署，可以使用以下配置为网关配置一组可以信任的已知证书：</p>
</div>
<div class="exampleblock">
<div class="title">Example 62. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      httpclient:
        ssl:
          trustedX509Certificates:
          - cert1.pem
          - cert2.pem</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>如果未为Spring Cloud Gateway提供受信任的证书，则使用默认的信任库（你可以通过设置 <code>javax.net.ssl.trustStore</code> 系统属性来覆盖它）。</p>
</div>
<div class="sect2">
<h3 id="_tls握手">7.1. TLS握手</h3>
<div class="paragraph">
<p>网关维护一个客户端池，该客户端池用于路由到后端。通过HTTPS进行通信时，客户端会启动TLS握手。
许多超时与此握手相关联。你可以配置这些超时，如下所示（显示默认值）：</p>
</div>
<div class="exampleblock">
<div class="title">Example 63. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      httpclient:
        ssl:
          handshake-timeout-millis: 10000
          close-notify-flush-timeout-millis: 3000
          close-notify-read-timeout-millis: 0</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_配置">8. 配置</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Cloud Gateway的配置由一组 <code>RouteDefinitionLocator</code> 实例驱动。
以下清单显示了 <code>RouteDefinitionLocator</code> 接口的定义：</p>
</div>
<div class="exampleblock">
<div class="title">Example 64. RouteDefinitionLocator.java</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">public interface RouteDefinitionLocator {
    Flux&lt;RouteDefinition&gt; getRouteDefinitions();
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>默认情况下，<code>PropertiesRouteDefinitionLocator</code> 通过使用Spring Boot的 <code>@ConfigurationProperties</code> 机制加载属性。</p>
</div>
<div class="paragraph">
<p>之前的配置示例均使用快捷方式符号，该快捷方式符号使用位置参数而不是命名参数。以下两个示例是等效的：</p>
</div>
<div class="exampleblock">
<div class="title">Example 65. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: setstatus_route
        uri: https://example.org
        filters:
        - name: SetStatus
          args:
            status: 401
      - id: setstatusshortcut_route
        uri: https://example.org
        filters:
        - SetStatus=401</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>对于网关的某些用法，properties是足够的，但是某些生产用例会受益于从外部源（例如：数据库）加载配置。
未来的里程碑版本将有基于Spring数据存储库（例如：Redis，MongoDB和Cassandra）的 <code>RouteDefinitionLocator</code> 实现。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_路由元数据配置">9. 路由元数据配置</h2>
<div class="sectionbody">
<div class="paragraph">
<p>你可以使用元数据为每个路由配置其他参数，如下所示：</p>
</div>
<div class="exampleblock">
<div class="title">Example 66. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      routes:
      - id: route_with_metadata
        uri: https://example.org
        metadata:
          optionName: "OptionValue"
          compositeObject:
            name: "value"
          iAmNumber: 1</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>你可以从一个交换中获取所有元数据属性，如下所示：</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>Route route = exchange.getAttribute(GATEWAY_ROUTE_ATTR);
// get all metadata properties
route.getMetadata();
// get a single metadata property
route.getMetadata(someKey);</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_http超时配置">10. Http超时配置</h2>
<div class="sectionbody">
<div class="paragraph">
<p>可以为所有路由配置Http超时（响应和连接），并为每个特定路由覆盖Http超时。</p>
</div>
<div class="sect2">
<h3 id="_全局超时">10.1. 全局超时</h3>
<div class="paragraph">
<p>要配置全局http超时：+
<code>connect-timeout</code> 必须以毫秒为单位指定。+
<code>response-timeout</code> 必须指定为 <code>java.time.Duration</code>。</p>
</div>
<div class="listingblock">
<div class="title">global http timeouts example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      httpclient:
        connect-timeout: 1000
        response-timeout: 5s</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_每个路由超时">10.2. 每个路由超时</h3>
<div class="paragraph">
<p>要配置每个路由超时：+
<code>connect-timeout</code> 必须以毫秒为单位指定。+
<code>response-timeout</code> 必须以毫秒为单位指定。</p>
</div>
<div class="listingblock">
<div class="title">per-route http timeouts configuration via configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">      - id: per_route_timeouts
        uri: https://example.org
        predicates:
          - name: Path
            args:
              pattern: /delay/{timeout}
        metadata:
          response-timeout: 200
          connect-timeout: 200</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">per-route timeouts configuration using Java DSL</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">import static org.springframework.cloud.gateway.support.RouteMetadataUtils.CONNECT_TIMEOUT_ATTR;
import static org.springframework.cloud.gateway.support.RouteMetadataUtils.RESPONSE_TIMEOUT_ATTR;

      @Bean
      public RouteLocator customRouteLocator(RouteLocatorBuilder routeBuilder){
         return routeBuilder.routes()
               .route("test1", r -&gt; {
                  return r.host("*.somehost.org").and().path("/somepath")
                        .filters(f -&gt; f.addRequestHeader("header1", "header-value-1"))
                        .uri("http://someuri")
                        .metadata(RESPONSE_TIMEOUT_ATTR, 200)
                        .metadata(CONNECT_TIMEOUT_ATTR, 200);
               })
               .build();
      }</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_流式java路由api">10.3. 流式Java路由API</h3>
<div class="paragraph">
<p>为了允许在Java中进行简单配置，<code>RouteLocatorBuilder</code> bean包含了一个流式API。以下清单显示了它的工作方式：</p>
</div>
<div class="exampleblock">
<div class="title">Example 67. GatewaySampleApplication.java</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">// static imports from GatewayFilters and RoutePredicates
@Bean
public RouteLocator customRouteLocator(RouteLocatorBuilder builder, ThrottleGatewayFilterFactory throttle) {
    return builder.routes()
            .route(r -&gt; r.host("**.abc.org").and().path("/image/png")
                .filters(f -&gt;
                        f.addResponseHeader("X-TestHeader", "foobar"))
                .uri("http://httpbin.org:80")
            )
            .route(r -&gt; r.path("/image/webp")
                .filters(f -&gt;
                        f.addResponseHeader("X-AnotherHeader", "baz"))
                .uri("http://httpbin.org:80")
                .metadata("key", "value")
            )
            .route(r -&gt; r.order(-1)
                .host("**.throttle.org").and().path("/get")
                .filters(f -&gt; f.filter(throttle.apply(1,
                        1,
                        10,
                        TimeUnit.SECONDS)))
                .uri("http://httpbin.org:80")
                .metadata("key", "value")
            )
            .build();
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>此样式还允许更多自定义谓词断言。由 <code>RouteDefinitionLocator</code> Bean定义的谓词使用逻辑 <code>and</code> 进行组合。
通过使用流式Java API，可以在 <code>Predicate</code> 类上使用 <code>and()</code>，<code>or()</code> 和 <code>negate()</code> 运算符。</p>
</div>
</div>
<div class="sect2">
<h3 id="__code_discoveryclient_code_路由定义定位器">10.4. <code>DiscoveryClient</code> 路由定义定位器</h3>
<div class="paragraph">
<p>你可以将网关配置为基于在 <code>DiscoveryClient</code> 服务注册中心中注册的服务来创建路由。</p>
</div>
<div class="paragraph">
<p>要启用此功能，请设置 <code>spring.cloud.gateway.discovery.locator.enabled=true</code>
并确保在类路径上启用了 <code>DiscoveryClient</code> 实现（例如：Netflix Eureka，Consul或Zookeeper）。</p>
</div>
<div class="sect3">
<h4 id="_为_code_discoveryclient_code_路由配置谓词和过滤器">10.4.1. 为 <code>DiscoveryClient</code> 路由配置谓词和过滤器</h4>
<div class="paragraph">
<p>默认情况下，fateway为使用 <code>DiscoveryClient</code> 创建的路由定义单个谓词和过滤器。</p>
</div>
<div class="paragraph">
<p>默认谓词是使用 <code>/serviceId/**</code> 模式定义的路径谓词，其中 <code>serviceId</code> 是来自 <code>DiscoveryClient</code> 的服务的ID。</p>
</div>
<div class="paragraph">
<p>默认过滤器是带有正则表达式 <code>/serviceId/(?&lt;remaining&gt;.*)</code> 和替换 <code>/${remaining}</code> 的重写路径过滤器。
这会在向下游发送请求之前从路径中剥离服务ID。</p>
</div>
<div class="paragraph">
<p>如果要自定义 <code>DiscoveryClient</code> 路由使用的谓词或过滤器，请设置 <code>spring.cloud.gateway.discovery.locator.predicates[x]</code>
和 <code>spring.cloud.gateway.discovery.locator.filters[y]</code>。这样做时，如果希望保留默认功能，则需要确保包括前面显示的默认谓词和过滤器。
下面的例子展示了如何做:</p>
</div>
<div class="exampleblock">
<div class="title">Example 68. application.properties</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties" data-lang="properties">spring.cloud.gateway.discovery.locator.predicates[0].name: Path
spring.cloud.gateway.discovery.locator.predicates[0].args[pattern]: "'/'+serviceId+'/**'"
spring.cloud.gateway.discovery.locator.predicates[1].name: Host
spring.cloud.gateway.discovery.locator.predicates[1].args[pattern]: "'**.foo.com'"
spring.cloud.gateway.discovery.locator.filters[0].name: Hystrix
spring.cloud.gateway.discovery.locator.filters[0].args[name]: serviceId
spring.cloud.gateway.discovery.locator.filters[1].name: RewritePath
spring.cloud.gateway.discovery.locator.filters[1].args[regexp]: "'/' + serviceId + '/(?&lt;remaining&gt;.*)'"
spring.cloud.gateway.discovery.locator.filters[1].args[replacement]: "'/${remaining}'"</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reactor_netty访问日志">11. Reactor Netty访问日志</h2>
<div class="sectionbody">
<div class="paragraph">
<p>要启用Reactor Netty访问日志，请设置 <code>-Dreactor.netty.http.server.accessLogEnabled=true</code>。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
它必须是Java系统属性，而不是Spring Boot属性。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>你可以将日志记录系统配置为具有单独的访问日志文件。以下示例创建一个Logback配置：</p>
</div>
<div class="exampleblock">
<div class="title">Example 69. logback.xml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml" data-lang="xml">    &lt;appender name="accessLog" class="ch.qos.logback.core.FileAppender"&gt;
        &lt;file&gt;access_log.log&lt;/file&gt;
        &lt;encoder&gt;
            &lt;pattern&gt;%msg%n&lt;/pattern&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;
    &lt;appender name="async" class="ch.qos.logback.classic.AsyncAppender"&gt;
        &lt;appender-ref ref="accessLog" /&gt;
    &lt;/appender&gt;

    &lt;logger name="reactor.netty.http.server.AccessLog" level="INFO" additivity="false"&gt;
        &lt;appender-ref ref="async"/&gt;
    &lt;/logger&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cors配置">12. CORS配置</h2>
<div class="sectionbody">
<div class="paragraph">
<p>你可以配置网关以控制CORS行为。“<code>global</code>” CORS配置是URL模式到
{javadoc-spring}/web/cors/CorsConfiguration.html[Spring Framework <code>CorsConfiguration</code>]的映射。以下示例配置了CORS：</p>
</div>
<div class="exampleblock">
<div class="title">Example 70. application.yml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    gateway:
      globalcors:
        corsConfigurations:
          '[/**]':
            allowedOrigins: "https://docs.spring.io"
            allowedMethods:
            - GET</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>在前面的示例中，对于所有GET请求的路径，允许来自 <code>docs.spring.io</code> 的请求中的CORS请求。</p>
</div>
<div class="paragraph">
<p>要为未由某些网关路由谓词处理的请求提供相同的CORS配置，
请将 <code>spring.cloud.gateway.globalcors.add-to-simple-url-handler-mapping</code> 属性设置为 <code>true</code>。
当你尝试支持CORS预检请求，并且你的路由谓词由于HTTP方法是 <code>options</code> 而未评估为 <code>true</code> 时，这很有用。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_actuator_api">13. Actuator API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>通过 <code>/gateway</code> 执行器端点，你可以监视Spring Cloud Gateway应用程序并与之交互。
为了可远程访问，必须在应用程序属性中
<a href="https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-endpoints.html#production-ready-endpoints-exposing-endpoints">通过HTTP或JMX公开</a>和
<a href="https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-endpoints.html#production-ready-endpoints-enabling-endpoints">启用</a>
端点。以下清单显示了如何执行此操作：</p>
</div>
<div class="exampleblock">
<div class="title">Example 71. application.properties</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties" data-lang="properties">management.endpoint.gateway.enabled=true # default value
management.endpoints.web.exposure.include=gateway</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_详细actuator格式">13.1. 详细Actuator格式</h3>
<div class="paragraph">
<p>新的，更详细的格式已添加到Spring Cloud Gateway。
它为每个路由添加了更多详细信息，使你可以查看与每个路由关联的谓词和过滤器以及任何可用的配置。
以下示例配置 <code>/actuator/gateway/routes</code>：</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json" data-lang="json">[
  {
    "predicate": "(Hosts: [**.addrequestheader.org] &amp;&amp; Paths: [/headers], match trailing slash: true)",
    "route_id": "add_request_header_test",
    "filters": [
      "[[AddResponseHeader X-Response-Default-Foo = 'Default-Bar'], order = 1]",
      "[[AddRequestHeader X-Request-Foo = 'Bar'], order = 1]",
      "[[PrefixPath prefix = '/httpbin'], order = 2]"
    ],
    "uri": "lb://testservice",
    "order": 0
  }
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>默认情况下启用此功能。要禁用它，请设置以下属性：</p>
</div>
<div class="exampleblock">
<div class="title">Example 72. application.properties</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties" data-lang="properties">spring.cloud.gateway.actuator.verbose.enabled=false</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>在将来的版本中，它将默认为 <code>true</code>。</p>
</div>
</div>
<div class="sect2">
<h3 id="_检索路由过滤器">13.2. 检索路由过滤器</h3>
<div class="paragraph">
<p>本节详细介绍如何检索路由过滤器，包括：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#gateway-global-filters">全局过滤器</a></p>
</li>
<li>
<p><a href="#gateway-single-route-filters">路由过滤器</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="gateway-global-filters">13.2.1. 全局过滤器</h4>
<div class="paragraph">
<p>要检索应用于所有路由的<a href="#global-filters">全局过滤器</a>，请发送 <code>GET</code> <code>/actuator/gateway/globalfilters</code> 请求。
产生的响应类似于以下内容：</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre>{
  "org.springframework.cloud.gateway.filter.LoadBalancerClientFilter@77856cc5": 10100,
  "org.springframework.cloud.gateway.filter.RouteToRequestUrlFilter@4f6fd101": 10000,
  "org.springframework.cloud.gateway.filter.NettyWriteResponseFilter@32d22650": -1,
  "org.springframework.cloud.gateway.filter.ForwardRoutingFilter@106459d9": 2147483647,
  "org.springframework.cloud.gateway.filter.NettyRoutingFilter@1fbd5e0": 2147483647,
  "org.springframework.cloud.gateway.filter.ForwardPathFilter@33a71d23": 0,
  "org.springframework.cloud.gateway.filter.AdaptCachedBodyGlobalFilter@135064ea": 2147483637,
  "org.springframework.cloud.gateway.filter.WebsocketRoutingFilter@23c05889": 2147483646
}</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>该响应包含已找到的全局过滤器的详细信息。
对于每个全局过滤器，过滤器对象都有一个字符串表示形式（例如：
<code>org.springframework.cloud.gateway.filter.LoadBalancerClientFilter@77856cc5</code>）以及它在过滤器链中的相应顺序。</p>
</div>
</div>
<div class="sect3">
<h4 id="gateway-single-route-filters">13.2.2. 路由过滤器</h4>
<div class="paragraph">
<p>要检索应用于路由的<a href="#gatewayfilter-factories"><code>GatewayFilter</code> 工厂</a>，请发送 <code>GET</code> <code>/actuator/gateway/routefilters</code> 请求。
产生的响应类似于以下内容：</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre>{
  "[AddRequestHeaderGatewayFilterFactory@570ed9c configClass = AbstractNameValueGatewayFilterFactory.NameValueConfig]": null,
  "[SecureHeadersGatewayFilterFactory@fceab5d configClass = Object]": null,
  "[SaveSessionGatewayFilterFactory@4449b273 configClass = Object]": null
}</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>该响应包含应用于任何特定路由的 <code>GatewayFilter</code> 工厂的详细信息。
对于每个工厂，都有一个对应对象的字符串表示形式（例如：<code>[SecureHeadersGatewayFilterFactory@fceab5d configClass = Object]</code>）。
请注意，<code>null</code> 值是由于端点控制器的实现不完整而引起的，因为它试图设置对象在过滤器链中的顺序，而这并不适用于 <code>GatewayFilter</code> 工厂对象。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_刷新路由缓存">13.3. 刷新路由缓存</h3>
<div class="paragraph">
<p>要清除路由缓存，请发送 <code>POST</code> <code>/actuator/gateway/refresh</code> 请求。该请求返回200，但没有响应体。</p>
</div>
</div>
<div class="sect2">
<h3 id="_检索网关中定义的路由">13.4. 检索网关中定义的路由</h3>
<div class="paragraph">
<p>要检索网关中定义的路由，请发送 <code>/actuator/gateway/routes</code> 请求。产生的响应类似于以下内容：</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre>[{
  "route_id": "first_route",
  "route_object": {
    "predicate": "org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory$$Lambda$432/1736826640@1e9d7e7d",
    "filters": [
      "OrderedGatewayFilter{delegate=org.springframework.cloud.gateway.filter.factory.PreserveHostHeaderGatewayFilterFactory$$Lambda$436/674480275@6631ef72, order=0}"
    ]
  },
  "order": 0
},
{
  "route_id": "second_route",
  "route_object": {
    "predicate": "org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory$$Lambda$432/1736826640@cd8d298",
    "filters": []
  },
  "order": 0
}]</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>该响应包含网关中定义的所有路由的详细信息。下表描述了响应的每个元素（每个均是一个路由）的结构：</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33%;">
<col style="width: 22%;">
<col style="width: 44%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">字段路径</th>
<th class="tableblock halign-left valign-top">类型</th>
<th class="tableblock halign-left valign-top">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>route_id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">路由ID。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>route_object.predicate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">路由谓词。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>route_object.filters</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">已应用于路由的<a href="#gatewayfilter-factories"><code>GatewayFilter</code> 工厂</a>。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>order</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">路由顺序。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="gateway-retrieving-information-about-a-particular-route">13.5. 检索有关特定路由的信息</h3>
<div class="paragraph">
<p>要检索有关单个路由的信息，请发送 <code>GET</code> <code>/actuator/gateway/routes/{id}</code>（例如：<code>/actuator/gateway/routes/first_route</code>）请求。
产生的响应类似于以下内容：</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre>{
  "id": "first_route",
  "predicates": [{
    "name": "Path",
    "args": {"_genkey_0":"/first"}
  }],
  "filters": [],
  "uri": "https://www.uri-destination.org",
  "order": 0
}]</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>下表描述了响应的结构：</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33%;">
<col style="width: 22%;">
<col style="width: 44%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">字段路径</th>
<th class="tableblock halign-left valign-top">类型</th>
<th class="tableblock halign-left valign-top">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">路由ID。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>predicates</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">路由谓词的集合。每个条目都定义给定谓词的名称和自变量。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>filters</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">应用于路由的过滤器集合。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>uri</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">路由的目标URI。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>order</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">路由顺序。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_创建和删除特定路由">13.6. 创建和删除特定路由</h3>
<div class="paragraph">
<p>要创建路由，请使用指定路由字段的JSON正文向 <code>/gateway/routes/{id_route_to_create}</code> 发送 <code>POST</code> 请求（请参阅 <a href="#gateway-retrieving-information-about-a-particular-route">检索有关特定路由的信息</a>）。</p>
</div>
<div class="paragraph">
<p>要删除路由，请向 <code>/gateway/routes/{id_route_to_delete}</code> 发送 <code>DELETE</code> 请求。</p>
</div>
</div>
<div class="sect2">
<h3 id="_回顾_所有端点的列表">13.7. 回顾：所有端点的列表</h3>
<div class="paragraph">
<p>下表总结了Spring Cloud Gateway执行器端点（请注意，每个端点都以 <code>/actuator/gateway</code> 为基本路径）：</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 22%;">
<col style="width: 22%;">
<col style="width: 55%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">ID</th>
<th class="tableblock halign-left valign-top">HTTP方法</th>
<th class="tableblock halign-left valign-top">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>globalfilters</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">显示应用于路由的全局过滤器列表。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>routefilters</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">显示应用于特定路由的 <code>GatewayFilter</code> 工厂列表。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>refresh</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">POST</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">清除路由缓存。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>routes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">显示网关中定义的路由列表。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>routes/{id}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">显示有关特定路由的信息。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>routes/{id}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">POST</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">将新路由添加到网关。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>routes/{id}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DELETE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">从网关中删除现有路由。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="troubleshooting">14. 故障排除</h2>
<div class="sectionbody">
<div class="paragraph">
<p>本部分介绍使用Spring Cloud Gateway时可能出现的常见问题。</p>
</div>
<div class="sect2">
<h3 id="_日志级别">14.1. 日志级别</h3>
<div class="paragraph">
<p>以下记录器可能包含 <code>DEBUG</code> 和 <code>TRACE</code> 级别的重要疑难解答信息：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>org.springframework.cloud.gateway</code></p>
</li>
<li>
<p><code>org.springframework.http.server.reactive</code></p>
</li>
<li>
<p><code>org.springframework.web.reactive</code></p>
</li>
<li>
<p><code>org.springframework.boot.autoconfigure.web</code></p>
</li>
<li>
<p><code>reactor.netty</code></p>
</li>
<li>
<p><code>redisratelimiter</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_窃听">14.2. 窃听</h3>
<div class="paragraph">
<p>Reactor Netty <code>HttpClient</code> 和 <code>HttpServer</code> 可以启用窃听。
与将 <code>reactor.netty</code> 日志级别设置为 <code>DEBUG</code> 或 <code>TRACE</code> 结合使用时，
它将启用信息记录，例如：通过网络发送和接收的头部和正文。
要启用窃听，请分别为 <code>HttpServer</code> 和 <code>HttpClient</code> 设置 <code>spring.cloud.gateway.httpserver.wiretap=true</code> 或
<code>spring.cloud.gateway.httpclient.wiretap=true</code>。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_开发人员指南">15. 开发人员指南</h2>
<div class="sectionbody">
<div class="paragraph">
<p>TODO: 编写自定义集成概述</p>
</div>
<div class="sect2">
<h3 id="_编写自定义路由谓词工厂">15.1. 编写自定义路由谓词工厂</h3>
<div class="paragraph">
<p>TODO: 编写自定义路由谓词工厂文档</p>
</div>
</div>
<div class="sect2">
<h3 id="_编写自定义gatewayfilter工厂">15.2. 编写自定义GatewayFilter工厂</h3>
<div class="paragraph">
<p>要编写 <code>GatewayFilter</code>，必须实现 <code>GatewayFilterFactory</code>。
你可以继承一个名为 <code>AbstractGatewayFilterFactory</code> 的抽象类。
以下示例显示了如何执行此操作：</p>
</div>
<div class="exampleblock">
<div class="title">Example 73. PreGatewayFilterFactory.java</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">public class PreGatewayFilterFactory extends AbstractGatewayFilterFactory&lt;PreGatewayFilterFactory.Config&gt; {

    public PreGatewayFilterFactory() {
        super(Config.class);
    }

    @Override
    public GatewayFilter apply(Config config) {
        // grab configuration from Config object
        return (exchange, chain) -&gt; {
            //If you want to build a "pre" filter you need to manipulate the
            //request before calling chain.filter
            ServerHttpRequest.Builder builder = exchange.getRequest().mutate();
            //use builder to manipulate the request
            return chain.filter(exchange.mutate().request(request).build());
        };
    }

    public static class Config {
        //Put the configuration properties for your filter here
    }

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">PostGatewayFilterFactory.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">public class PostGatewayFilterFactory extends AbstractGatewayFilterFactory&lt;PostGatewayFilterFactory.Config&gt; {

    public PostGatewayFilterFactory() {
        super(Config.class);
    }

    @Override
    public GatewayFilter apply(Config config) {
        // grab configuration from Config object
        return (exchange, chain) -&gt; {
            return chain.filter(exchange).then(Mono.fromRunnable(() -&gt; {
                ServerHttpResponse response = exchange.getResponse();
                //Manipulate the response in some way
            }));
        };
    }

    public static class Config {
        //Put the configuration properties for your filter here
    }

}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_编写自定义全局过滤器">15.3. 编写自定义全局过滤器</h3>
<div class="paragraph">
<p>要编写自定义全局过滤器，必须实现 <code>GlobalFilter</code> 接口。这会将过滤器应用于所有请求。</p>
</div>
<div class="paragraph">
<p>以下示例显示如何分别设置全局前置和后置过滤器：</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">@Bean
public GlobalFilter customGlobalFilter() {
    return (exchange, chain) -&gt; exchange.getPrincipal()
        .map(Principal::getName)
        .defaultIfEmpty("Default User")
        .map(userName -&gt; {
          //adds header to proxied request
          exchange.getRequest().mutate().header("CUSTOM-REQUEST-HEADER", userName).build();
          return exchange;
        })
        .flatMap(chain::filter);
}

@Bean
public GlobalFilter customGlobalPostFilter() {
    return (exchange, chain) -&gt; chain.filter(exchange)
        .then(Mono.just(exchange))
        .map(serverWebExchange -&gt; {
          //adds header to response
          serverWebExchange.getResponse().getHeaders().set("CUSTOM-RESPONSE-HEADER",
              HttpStatus.OK.equals(serverWebExchange.getResponse().getStatusCode()) ? "It worked": "It did not work");
          return serverWebExchange;
        })
        .then();
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_编写自定义路由locators和writers">15.4. 编写自定义路由Locators和Writers</h3>
<div class="paragraph">
<p>TODO: 编写自定义路由Locators和Writers文档</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_使用spring_mvc或webflux构建一个简单的网关">16. 使用Spring MVC或Webflux构建一个简单的网关</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Cloud Gateway提供了一个名为 <code>ProxyExchange</code> 的实用工具对象。
你可以在常规的Spring Web处理程序中使用它作为方法参数。它通过mirror HTTP动词的方法支持基本的下游HTTP交换。
使用MVC，它还支持通过 <code>forward()</code> 方法转发到本地处理程序。
要使用 <code>ProxyExchange</code>，请在类路径中包含正确的模块（<code>spring-cloud-gateway-mvc</code> 或 <code>spring-cloud-gateway-webflux</code>）。</p>
</div>
<div class="paragraph">
<p>以下MVC示例代理了对 <code>/test</code> 的请求，将其委托到下游的远程服务器：</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">@RestController
@SpringBootApplication
public class GatewaySampleApplication {

    @Value("${remote.home}")
    private URI home;

    @GetMapping("/test")
    public ResponseEntity&lt;?&gt; proxy(ProxyExchange&lt;byte[]&gt; proxy) throws Exception {
        return proxy.uri(home.toString() + "/image/png").get();
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>以下示例对Webflux执行相同的操作：</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">@RestController
@SpringBootApplication
public class GatewaySampleApplication {

    @Value("${remote.home}")
    private URI home;

    @GetMapping("/test")
    public Mono&lt;ResponseEntity&lt;?&gt;&gt; proxy(ProxyExchange&lt;byte[]&gt; proxy) throws Exception {
        return proxy.uri(home.toString() + "/image/png").get();
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><code>ProxyExchange</code> 上的便捷方法使处理程序方法可以发现并增强传入请求的URI路径。
例如：你可能想要提取路径末尾的元素以将它们传递到下游：</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">@GetMapping("/proxy/path/**")
public ResponseEntity&lt;?&gt; proxyPath(ProxyExchange&lt;byte[]&gt; proxy) throws Exception {
  String path = proxy.path("/proxy/path/");
  return proxy.uri(home.toString() + "/foos/" + path).get();
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>网关处理程序方法可以使用Spring MVC和Webflux的所有功能。
结果，例如：你可以注入请求头和查询参数，并且可以使用映射注解中的声明来约束传入的请求。
有关这些功能的更多详细信息，请参见Spring MVC中有关 <code>@RequestMapping</code> 的文档。</p>
</div>
<div class="paragraph">
<p>你可以使用 <code>ProxyExchange</code> 上的 <code>header()</code> 方法将头部添加到下游响应中。</p>
</div>
<div class="paragraph">
<p>你还可以通过将映射器添加到 <code>get()</code> 方法（和其他方法）来操纵响应头（以及响应中你喜欢的任何其他内容）。
映射器是一个 <code>Function</code>，它接收传入的 <code>ResponseEntity</code> 并将其转换为传出的实体。</p>
</div>
<div class="paragraph">
<p>对不传递到下游的“<code>sensitive</code>”头部（默认情况下为 <code>cookie</code> 和 <code>authorization</code>）和 “<code>proxy</code>”头部(<code>x-forwarded-*</code>) 提供一流的支持。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_配置属性">17. 配置属性</h2>
<div class="sectionbody">
<div class="paragraph">
<p>要查看所有与Spring Cloud Gateway相关的配置属性的列表，请参阅<a href="#appendix">附录</a>。</p>
</div>
<div class="paragraph">
<p>Unresolved directive in gateway.adoc - include::appendix.adoc[leveloffset=+1]</p>
</div>
</div>
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
</body>
</html>